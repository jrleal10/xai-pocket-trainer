<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10a37f">
  <meta name="description" content="Interview preparation for xAI - Master your pitch, practice objections, memorize key concepts">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Block all search engines and crawlers -->
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="bingbot" content="noindex, nofollow">

  <title>xAI Pocket Trainer</title>

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-512.png">

  <style>
    /* ============================================
       SECTION 1: CSS RESET & VARIABLES
       ============================================ */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Backgrounds */
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-card: #242424;

      /* Accent */
      --accent-primary: #10a37f;
      --accent-secondary: #0d8a6a;

      /* Status */
      --color-success: #10a37f;
      --color-warning: #f59e0b;
      --color-error: #ef4444;

      /* Text */
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #6b6b6b;

      /* Borders */
      --border-color: #333333;

      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }

    /* ============================================
       SECTION 2: BASE STYLES
       ============================================ */

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      font-size: 16px;
      line-height: 1.5;
      background: var(--bg-primary);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
    }

    h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    /* ============================================
       SECTION 3: LAYOUT COMPONENTS
       ============================================ */

    .container {
      max-width: 100%;
      padding: var(--spacing-md);
      min-height: 100vh;
    }

    @media (min-width: 768px) {
      .container {
        max-width: 480px;
        margin: 0 auto;
      }
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      margin-bottom: var(--spacing-md);
    }

    .btn {
      background: var(--accent-primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      min-height: 44px;
      line-height: 20px;
    }

    .btn:hover {
      background: var(--accent-secondary);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
      border-color: var(--accent-primary);
    }

    /* ============================================
       SECTION 4: DASHBOARD STYLES
       ============================================ */

    .header {
      text-align: center;
      padding: var(--spacing-lg) 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: var(--spacing-lg);
    }

    .header h1 {
      color: var(--accent-primary);
      margin-bottom: var(--spacing-xs);
    }

    .header .subtitle {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .countdown-container {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .countdown-container h2 {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: var(--spacing-sm);
    }

    .countdown-display {
      font-family: 'SF Mono', 'Roboto Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: var(--spacing-sm);
    }

    .countdown-display.today {
      color: var(--color-warning);
      font-size: 2.5rem;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .countdown-date {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .phrase-moment {
      background: var(--bg-card);
      border-radius: 12px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .phrase-moment:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .phrase-moment h3 {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--spacing-sm);
    }

    .phrase-text {
      color: var(--text-primary);
      font-size: 1.125rem;
      line-height: 1.6;
      text-align: center;
    }

    .phrase-hint {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
      margin-top: var(--spacing-sm);
    }

    .mode-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .mode-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: var(--spacing-lg);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: var(--text-primary);
      display: block;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .mode-btn:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      background: var(--bg-card);
    }

    .mode-btn .icon {
      font-size: 2rem;
      margin-bottom: var(--spacing-sm);
    }

    .mode-btn .title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }

    .mode-btn .duration {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .random-pill-btn {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      padding: var(--spacing-lg);
      font-size: 1.125rem;
    }

    .random-pill-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
    }

    /* ============================================
       SECTION 5: FLASHCARDS STYLES
       ============================================ */

    .flashcard-controls {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }

    .flashcard-controls select {
      flex: 1;
      min-width: 150px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      font-size: 1rem;
    }

    .flashcard-controls button {
      flex: 0 0 auto;
    }

    .progress-indicator {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
      font-size: 0.875rem;
    }

    .flashcard-container {
      perspective: 1000px;
      margin-bottom: var(--spacing-lg);
      min-height: 400px;
    }

    .flashcard {
      position: relative;
      width: 100%;
      min-height: 400px;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      cursor: pointer;
    }

    .flashcard.flipped {
      transform: rotateY(180deg);
    }

    .flashcard-face {
      position: absolute;
      width: 100%;
      min-height: 400px;
      backface-visibility: hidden;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: var(--spacing-xl);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .flashcard-face.front {
      border-color: var(--accent-primary);
    }

    .flashcard-face.back {
      transform: rotateY(180deg);
      border-color: var(--color-success);
    }

    .flashcard-face .category-badge {
      position: absolute;
      top: var(--spacing-md);
      right: var(--spacing-md);
      background: var(--accent-primary);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .flashcard-face .content {
      font-size: 1.25rem;
      line-height: 1.6;
      color: var(--text-primary);
    }

    .flashcard-face.front .content {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .flashcard-actions {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .flashcard-actions button {
      flex: 1;
      padding: var(--spacing-md);
      font-size: 1rem;
    }

    .swipe-left {
      background: var(--color-warning);
    }

    .swipe-right {
      background: var(--color-success);
    }

    /* ============================================
       SECTION 6: NAVIGATION
       ============================================ */

    .back-button {
      margin-bottom: var(--spacing-lg);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      width: auto;
    }

    .back-button:hover {
      border-color: var(--accent-primary);
      background: var(--bg-card);
    }

    /* ============================================
       SECTION 7: UTILITY CLASSES
       ============================================ */

    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--text-muted);
    }

    .mb-lg {
      margin-bottom: var(--spacing-lg);
    }

    /* ============================================
       SECTION 7.5: TIMER MODE STYLES
       ============================================ */

    .timer-container {
      text-align: center;
      padding: var(--spacing-xl) 0;
    }

    .time-selector {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      margin-bottom: var(--spacing-xl);
    }

    .time-selector .btn {
      flex: 1;
      max-width: 100px;
    }

    .time-selector .btn.selected {
      background: var(--accent-secondary);
      border: 2px solid var(--accent-primary);
    }

    .prompt-display {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .prompt-text {
      font-size: 1.5rem;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-primary);
    }

    .timer-display-large {
      font-family: 'SF Mono', 'Roboto Mono', monospace;
      font-size: 5rem;
      font-weight: 700;
      margin: var(--spacing-xl) 0;
      transition: color 0.3s ease;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--bg-secondary);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: var(--spacing-xl);
    }

    .progress-fill {
      height: 100%;
      transition: width 0.1s linear, background 0.3s ease;
      border-radius: 6px;
    }

    .timer-phase-green {
      background: var(--color-success);
    }

    .timer-phase-green .timer-display-large {
      color: var(--color-success);
    }

    .timer-phase-green .progress-fill {
      background: var(--color-success);
    }

    .timer-phase-yellow {
      background: var(--color-warning);
    }

    .timer-phase-yellow .timer-display-large {
      color: var(--color-warning);
    }

    .timer-phase-yellow .progress-fill {
      background: var(--color-warning);
    }

    .timer-phase-red {
      background: var(--color-error);
      animation: pulse-bg 0.5s ease-in-out infinite;
    }

    .timer-phase-red .timer-display-large {
      color: var(--color-error);
      animation: pulse-text 0.5s ease-in-out infinite;
    }

    .timer-phase-red .progress-fill {
      background: var(--color-error);
    }

    @keyframes pulse-bg {
      0%, 100% { background: var(--bg-primary); }
      50% { background: rgba(239, 68, 68, 0.2); }
    }

    @keyframes pulse-text {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .wrap-up-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-error);
      margin-top: var(--spacing-md);
      animation: pulse-text 0.5s ease-in-out infinite;
    }

    .review-section {
      margin-top: var(--spacing-xl);
    }

    .checklist {
      text-align: left;
      background: var(--bg-card);
      border-radius: 12px;
      padding: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }

    .checklist-item {
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.875rem;
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checklist-item input[type="checkbox"] {
      margin-right: var(--spacing-sm);
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .ideal-script {
      background: var(--bg-secondary);
      border-left: 4px solid var(--accent-primary);
      padding: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
      border-radius: 8px;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 0.938rem;
    }

    .btn-group {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .btn-group .btn {
      flex: 1;
    }

    /* ============================================
       SECTION 8: LOADING STATE
       ============================================ */

    .loading {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
    }

    .spinner {
      border: 3px solid var(--bg-secondary);
      border-top: 3px solid var(--accent-primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--spacing-md);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============================================
       RANDOM PILL STYLES
       ============================================ */

    .pill-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: var(--spacing-lg);
      margin-top: var(--spacing-lg);
      min-height: 300px;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .pill-type-header {
      background: var(--accent-primary);
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }

    .pill-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .pill-text {
      font-size: 1.1rem;
      line-height: 1.6;
      text-align: center;
      padding: var(--spacing-lg);
    }

    .pill-quiz-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
      width: 100%;
      max-width: 400px;
    }

    .quiz-result {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }

    .quiz-result.correct {
      background: var(--color-success);
      color: white;
    }

    .quiz-result.wrong {
      background: var(--color-error);
      color: white;
    }

    .pill-actions {
      display: flex;
      justify-content: center;
      margin-top: var(--spacing-md);
    }

    /* ============================================
       PRE-FLIGHT CHECKLIST STYLES
       ============================================ */

    .preflight-progress {
      margin: var(--spacing-lg) 0;
    }

    .progress-bar {
      background: var(--bg-secondary);
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: var(--spacing-sm);
    }

    .progress-fill {
      background: var(--accent-primary);
      height: 100%;
      transition: width 0.3s ease;
    }

    .checklist-sections {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      margin: var(--spacing-lg) 0;
    }

    .checklist-section h3 {
      color: var(--accent-primary);
      margin-bottom: var(--spacing-md);
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) 0;
    }

    .checkbox-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .checkbox-item input[type="checkbox"]:checked + label {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .checkbox-item label {
      cursor: pointer;
      flex: 1;
    }

    .mini-stories {
      margin: var(--spacing-xl) 0;
    }

    .mini-card {
      background: var(--bg-card);
      padding: var(--spacing-md);
      border-radius: 12px;
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: background 0.2s;
    }

    .mini-card:hover {
      background: var(--bg-secondary);
    }

    .mini-card h4 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0;
    }

    .mini-content {
      margin-top: var(--spacing-sm);
      padding-top: var(--spacing-sm);
      border-top: 1px solid var(--border-color);
    }

    .mini-content.hidden {
      display: none;
    }

    .closing-card {
      background: var(--accent-primary);
      color: white;
      cursor: default;
    }

    .closing-card:hover {
      background: var(--accent-primary);
    }

    .closing-question {
      margin-top: var(--spacing-sm);
      font-style: italic;
      font-size: 1.1rem;
      line-height: 1.6;
    }

    /* ==========================================
       V√≠cio Police Styles
       ========================================== */
    .vicio-practice {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .vicio-prompt-display {
      background: var(--bg-card);
      padding: var(--spacing-lg);
      border-radius: 12px;
      font-size: 1.2rem;
      text-align: center;
      border-left: 4px solid var(--accent-primary);
    }

    .vicio-status {
      text-align: center;
      font-size: 1.2rem;
      padding: var(--spacing-sm);
      animation: pulse 2s infinite;
    }

    .transcript-box {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: 8px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .vicio-alerts {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      min-height: 50px;
    }

    .alert-banner {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 8px;
      font-weight: 600;
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .alert-forbidden {
      background: var(--color-error);
      color: white;
      animation: pulse 0.5s, slideIn 0.3s;
    }

    .alert-desired {
      background: var(--color-success);
      color: white;
    }

    /* ==========================================
       V3.0 - Bridge Alert Styles
       ========================================== */
    .bridge-alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 16px 32px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(255, 107, 107, 0.5);
      animation: pulseScale 0.5s ease-in-out, slideDown 0.3s ease;
      z-index: 10000;
      text-align: center;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    @keyframes pulseScale {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* ==========================================
       V3.0 - Panic Word Overlay Styles
       ========================================== */
    .panic-word-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 20000;
    }

    .panic-word-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .panic-word {
      font-size: 72px;
      font-weight: bold;
      color: var(--accent-primary);
      text-transform: uppercase;
      text-shadow: 0 0 20px rgba(16, 163, 127, 0.5);
      animation: fadeInScale 0.3s ease;
    }

    .panic-context {
      font-size: 18px;
      color: var(--text-secondary);
      margin-top: 16px;
      opacity: 0.8;
    }

    @keyframes fadeInScale {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .vicio-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      margin: var(--spacing-lg) 0;
    }

    .stat-block {
      background: var(--bg-card);
      padding: var(--spacing-md);
      border-radius: 12px;
    }

    .stat-block h3 {
      font-size: 1rem;
      margin-bottom: var(--spacing-sm);
    }

    .stat-count {
      font-size: 2.5rem;
      font-weight: 700;
      margin: var(--spacing-sm) 0;
    }

    .stat-list {
      list-style: none;
      padding: 0;
      margin: var(--spacing-sm) 0 0 0;
    }

    .stat-list li {
      padding: var(--spacing-xs) 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
    }

    .stat-list li:last-child {
      border-bottom: none;
    }

    .vicio-results-actions {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: center;
      margin-top: var(--spacing-md);
    }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      .vicio-stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-count {
        font-size: 2rem;
      }
    }

    /* ============================================
       V4.0 - REHEARSAL MODE STYLES
       ============================================ */

    /* Seletor de Momentos */
    .moment-selector h1 {
      margin-bottom: var(--spacing-sm);
    }

    .moment-selector p {
      margin-bottom: var(--spacing-lg);
    }

    .moment-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }

    .moment-btn {
      padding: var(--spacing-lg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .moment-btn:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 163, 127, 0.2);
    }

    .moment-btn.active {
      border-color: var(--accent-primary);
      background: rgba(16, 163, 127, 0.1);
    }

    .moment-btn .moment-label {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      display: block;
    }

    .moment-btn .moment-time {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: block;
    }

    .moment-btn .moment-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
      display: block;
    }

    /* Lista de Scripts */
    .script-list {
      margin-top: var(--spacing-lg);
    }

    .script-list h2 {
      margin-bottom: var(--spacing-lg);
    }

    .script-card {
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-card);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .script-card:hover {
      border-color: var(--accent-primary);
      background: rgba(16, 163, 127, 0.05);
      transform: translateY(-1px);
    }

    .script-card.is-killer {
      border-left: 4px solid #FFD700;
    }

    .script-card .script-info h4 {
      margin: 0 0 var(--spacing-xs) 0;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .script-card .script-info .duration {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .script-card .killer-badge {
      background: #FFD700;
      color: #000;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Tela de Pr√°tica */
    .practice-screen {
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .practice-header {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    .script-meta {
      flex: 1;
    }

    .script-meta h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .duration-badge {
      display: inline-block;
      background: var(--accent-primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-top: var(--spacing-xs);
    }

    /* √Årea do Script */
    .script-area {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .script-text {
      font-size: 1.05rem;
      line-height: 1.8;
      white-space: pre-wrap;
      color: var(--text-primary);
      margin-bottom: var(--spacing-lg);
    }

    .script-text strong {
      color: var(--accent-primary);
      font-weight: 600;
    }

    .tips-section {
      padding-top: var(--spacing-md);
      border-top: 1px dashed var(--border-color);
    }

    .tips-section h4 {
      margin: 0 0 var(--spacing-sm) 0;
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .tips-section ul {
      margin: 0;
      padding-left: 1.25rem;
    }

    .tips-section li {
      margin-bottom: var(--spacing-xs);
      color: var(--text-muted);
    }

    /* Controles de Pr√°tica */
    .practice-controls {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    /* Controles de √Åudio Gravado */
    .audio-controls {
      display: flex;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
      animation: fadeIn 0.3s ease;
    }

    .audio-controls button {
      border: 2px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .audio-controls button:hover {
      border-color: var(--accent-primary);
      background: var(--bg-card);
    }

    .tts-btn, .record-btn {
      flex: 1;
      padding: var(--spacing-lg);
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tts-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .tts-btn:hover {
      background: var(--bg-card);
      border-color: var(--accent-primary);
    }

    .tts-btn.speaking {
      background: var(--accent-primary);
      color: white;
      animation: pulse 1s infinite;
    }

    .record-btn {
      background: var(--accent-primary);
      color: white;
    }

    .record-btn:hover {
      filter: brightness(1.1);
    }

    .record-btn.recording {
      background: var(--color-error);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Feedback da IA */
    .ai-feedback {
      background: linear-gradient(135deg, rgba(16, 163, 127, 0.1), rgba(255, 215, 0, 0.1));
      border: 1px solid var(--accent-primary);
      border-radius: 12px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-feedback h4 {
      margin: 0 0 var(--spacing-md) 0;
      color: var(--accent-primary);
      font-size: 1.1rem;
    }

    .feedback-content {
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
    }

    .feedback-content .strength {
      color: var(--color-success);
    }

    .feedback-content .improvement {
      color: var(--color-warning);
    }

    .transcript-section, .comparison-section {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px dashed var(--border-color);
    }

    .transcript-section h5, .comparison-section h5 {
      margin: 0 0 var(--spacing-sm) 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    #user-transcript {
      font-style: italic;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: 8px;
      line-height: 1.6;
    }

    .key-phrases-check {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .phrase-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .phrase-tag.found {
      background: var(--color-success);
      color: white;
    }

    .phrase-tag.missing {
      background: var(--color-error);
      color: white;
      opacity: 0.7;
    }

    /* Navega√ß√£o */
    .navigation-buttons {
      display: flex;
      gap: var(--spacing-md);
      justify-content: space-between;
    }

    .navigation-buttons button {
      flex: 1;
      padding: var(--spacing-md);
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
      border-color: var(--accent-primary);
    }

    /* Loading spinner */
    .loading-spinner {
      text-align: center;
      padding: var(--spacing-lg);
      color: var(--text-secondary);
      animation: pulse 1.5s infinite;
    }

    /* Mobile adjustments for Rehearsal Mode */
    @media (max-width: 600px) {
      .moment-buttons {
        grid-template-columns: 1fr;
      }

      .practice-controls {
        flex-direction: column;
      }

      .audio-controls {
        flex-direction: column;
      }

      .navigation-buttons {
        flex-direction: column;
      }

      .script-text {
        font-size: 1rem;
      }

      .practice-header {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* ============================================
       AUDIO COACH MODE STYLES
       ============================================ */

    .audio-category-selector {
      margin-bottom: var(--spacing-xl);
    }

    .audio-category-selector h3 {
      margin-bottom: var(--spacing-sm);
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .audio-category-selector select {
      width: 100%;
      padding: var(--spacing-md);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
    }

    /* Now Playing Card */
    .now-playing {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
      min-height: 140px;
    }

    .now-playing-icon {
      font-size: 4rem;
      flex-shrink: 0;
    }

    .now-playing-info {
      flex: 1;
    }

    .now-playing-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      line-height: 1.4;
    }

    .now-playing-subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    /* Progress Bar */
    .audio-progress {
      margin-bottom: var(--spacing-xl);
    }

    .audio-progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: var(--spacing-sm);
    }

    .audio-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      width: 0%;
      transition: width 0.3s ease;
    }

    .audio-progress-text {
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    /* Playback Controls */
    .audio-controls-panel {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg) 0;
    }

    .audio-control-btn {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .audio-control-btn:hover:not(:disabled) {
      border-color: var(--accent-primary);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
    }

    .audio-control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .audio-control-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .audio-control-btn-play {
      width: 90px;
      height: 90px;
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .audio-control-btn-play:hover:not(:disabled) {
      background: var(--accent-secondary);
      border-color: var(--accent-secondary);
    }

    /* Settings */
    .audio-settings {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .audio-setting-item {
      margin-bottom: var(--spacing-md);
    }

    .audio-setting-item:last-child {
      margin-bottom: 0;
    }

    .audio-setting-label {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .audio-setting-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .audio-setting-label select {
      margin-left: auto;
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
    }

    /* Playlist */
    .audio-playlist {
      margin-top: var(--spacing-xl);
    }

    .audio-playlist h4 {
      margin-bottom: var(--spacing-md);
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .playlist-items {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
    }

    .playlist-item {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .playlist-item:last-child {
      border-bottom: none;
    }

    .playlist-item:hover {
      background: var(--bg-card);
    }

    .playlist-item.active {
      background: rgba(16, 163, 127, 0.1);
      border-left: 4px solid var(--accent-primary);
    }

    .playlist-item.active .playlist-item-title {
      color: var(--accent-primary);
      font-weight: 600;
    }

    .playlist-item-number {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 600;
      min-width: 30px;
    }

    .playlist-item-title {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .playlist-item-duration {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .playlist-item.is-killer::before {
      content: '‚≠ê';
      font-size: 1rem;
    }

    /* Mobile adjustments for Audio Coach */
    @media (max-width: 600px) {
      .now-playing {
        flex-direction: column;
        text-align: center;
        padding: var(--spacing-lg);
      }

      .now-playing-icon {
        font-size: 3rem;
      }

      .now-playing-title {
        font-size: 1.1rem;
      }

      .audio-control-btn {
        width: 60px;
        height: 60px;
      }

      .audio-control-btn-play {
        width: 80px;
        height: 80px;
      }

      .audio-controls-panel {
        gap: var(--spacing-md);
      }

      .playlist-items {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>

  <!-- ============================================
       SECTION 1: DASHBOARD VIEW
       ============================================ -->

  <div id="dashboard" class="view active">
    <div class="container">
      <div class="header">
        <h1>üéØ xAI Pocket Trainer</h1>
        <p class="subtitle">Interview Preparation for xAI</p>
      </div>

      <div class="countdown-container">
        <h2>‚è±Ô∏è COUNTDOWN TIMER</h2>
        <div class="countdown-display" id="countdown-display">
          Loading...
        </div>
        <div class="countdown-date">at√© 05/01/2026 √†s 17:00 BRT</div>
      </div>

      <div class="phrase-moment" id="phrase-moment" onclick="nextPhrase()">
        <h3>üí¨ FRASE DO MOMENTO</h3>
        <div class="phrase-text" id="phrase-text">
          Loading...
        </div>
        <div class="phrase-hint">Tap para pr√≥xima frase</div>
      </div>

      <div class="mode-grid">
        <a href="#flashcards" class="mode-btn">
          <div class="icon">üíä</div>
          <div class="title">Flashcards</div>
          <div class="duration">2 min</div>
        </a>

        <a href="#pitch" class="mode-btn">
          <div class="icon">‚è±Ô∏è</div>
          <div class="title">45-Sec Pitch</div>
          <div class="duration">8 prompts</div>
        </a>

        <a href="#objections" class="mode-btn">
          <div class="icon">üí£</div>
          <div class="title">Objections</div>
          <div class="duration">10 obje√ß√µes</div>
        </a>

        <a href="#vicio-police" class="mode-btn">
          <div class="icon">üö®</div>
          <div class="title">V√≠cio Police</div>
          <div class="duration">Speech Recognition</div>
        </a>

        <a href="#random-pill" class="mode-btn random-pill-btn">
          <div class="icon">üé≤</div>
          <div class="title">RANDOM PILL</div>
          <div class="duration">D√° algo √∫til em 30seg</div>
        </a>

        <a href="#rehearsal-mode" class="mode-btn" onclick="event.preventDefault(); showRehearsalMode();">
          <div class="icon">üé≠</div>
          <div class="title">Rehearsal Mode</div>
          <div class="duration">Pratique scripts em voz alta</div>
        </a>

        <a href="#audio-coach" class="mode-btn">
          <div class="icon">üéß</div>
          <div class="title">Audio Coach</div>
          <div class="duration">Ou√ßa enquanto dirige/cozinha</div>
        </a>

        <a href="#preflight" class="mode-btn">
          <div class="icon">üìã</div>
          <div class="title">Pre-Flight Checklist</div>
          <div class="duration">Dia 05</div>
        </a>

      </div>
    </div>
  </div>

  <!-- ============================================
       SECTION 2: FLASHCARDS VIEW
       ============================================ -->

  <div id="flashcards" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">
        ‚Üê Voltar
      </button>

      <h1 class="text-center mb-lg">üíä Flashcards</h1>

      <div class="flashcard-controls">
        <select id="category-filter" onchange="filterByCategory()">
          <option value="all">Todas as Categorias</option>
          <option value="killer">üèÜ KILLER STORIES</option>
          <option value="tecnico">T√©cnico</option>
          <option value="historias">Hist√≥rias</option>
          <option value="pessoas">Pessoas</option>
          <option value="frases">Frases-Chave</option>
          <option value="dos-donts">Do's & Don'ts</option>
        </select>

        <button class="btn btn-secondary" onclick="shuffleCards()" style="width: auto; padding: 12px 20px;">
          üîÄ Shuffle
        </button>
      </div>

      <div class="progress-indicator" id="card-progress">
        Card 1 of 45
      </div>

      <div class="flashcard-container">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="flashcard-face front">
            <span class="category-badge" id="card-category">T√©cnico</span>
            <div class="content" id="card-front">
              Carregando...
            </div>
          </div>
          <div class="flashcard-face back">
            <span class="category-badge" id="card-category-back">T√©cnico</span>
            <div class="content" id="card-back">
              Carregando...
            </div>
          </div>
        </div>
      </div>

      <div class="flashcard-actions">
        <button class="btn btn-secondary" onclick="speakCard()" style="flex: 0 0 50px; padding: 12px; font-size: 1.5rem;">
          üîä
        </button>
        <button class="btn swipe-left" onclick="markForReview()">
          ‚Üê Preciso Revisar
        </button>
        <button class="btn swipe-right" onclick="markAsKnown()">
          Sei Bem ‚Üí
        </button>
      </div>

      <div class="text-center text-muted" style="font-size: 0.875rem;">
        Ou deslize o card: ‚Üê revisar | sei bem ‚Üí
      </div>
    </div>
  </div>

  <!-- ============================================
       SECTION 3: PLACEHOLDER VIEWS (Coming Soon)
       ============================================ -->

  <div id="pitch" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
      <h1 class="text-center">‚è±Ô∏è 45-Second Pitch</h1>

      <!-- Time Selection Screen -->
      <div id="pitch-setup" class="timer-container">
        <p class="text-muted text-center">Escolha o tempo de pr√°tica:</p>
        <div class="time-selector">
          <button class="time-btn" data-seconds="45">45s</button>
          <button class="time-btn active" data-seconds="60">60s</button>
          <button class="time-btn" data-seconds="90">90s</button>
        </div>

        <div class="card" style="margin-top: 2rem;">
          <h3 id="current-prompt-title">Prompt 1 de 8</h3>
          <div class="prompt-display" id="prompt-text">Tell me about yourself</div>
        </div>

        <button class="btn btn-secondary" id="view-script-btn" style="margin-top: 2rem; width: 100%; padding: 0.75rem; border: 2px dashed var(--border-color);" onclick="toggleScriptPreview()">
          üìñ Ver Script Antes
        </button>

        <button class="btn btn-primary" id="start-timer-btn" style="margin-top: 1rem; width: 100%; font-size: 1.25rem; padding: 1rem;">
          START
        </button>
      </div>

      <!-- Timer Running Screen -->
      <div id="pitch-running" class="timer-container" style="display: none;">
        <div class="prompt-display" id="running-prompt">Tell me about yourself</div>

        <div class="timer-display-large" id="timer-display">60</div>

        <div class="progress-bar-container">
          <div class="progress-bar" id="timer-progress"></div>
        </div>

        <!-- Panic Button Feature -->
        <button id="panic-btn" class="btn btn-error" style="margin-top: 1rem; display: none;" onclick="showPanicWord()">
          üÜò PANIC WORD
        </button>
        <div id="panic-overlay" style="display: none; background: rgba(0,0,0,0.9); position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 2rem; border-radius: 12px; z-index: 100; text-align: center;">
          <h3 style="color: var(--color-warning); margin-bottom: 1.5rem;">BRIDGE PHRASES</h3>
          <p class="panic-phrase" onclick="closePanic()" style="background: #333; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer;">"The core principle here is..."</p>
          <p class="panic-phrase" onclick="closePanic()" style="background: #333; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer;">"Bringing it back to the Joule experience..."</p>
          <p class="panic-phrase" onclick="closePanic()" style="background: #333; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; cursor: pointer;">"What matters is the fundamental analysis..."</p>
          <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="closePanic()">Close</button>
        </div>

        <div id="wrap-up-message" style="display: none; color: var(--color-error); font-weight: 700; margin-top: 1rem; font-size: 1.25rem;">
          WRAP UP!
        </div>
      </div>

      <!-- Review Screen -->
      <div id="pitch-review" class="timer-container" style="display: none;">
        <h2 class="text-center" style="color: var(--accent-primary); margin-bottom: 2rem;">‚è±Ô∏è Time's Up!</h2>

        <div class="card">
          <h3 style="margin-bottom: 1rem;">‚úÖ Checklist</h3>
          <div id="review-checklist" class="review-checklist">
            <!-- Checklist items will be inserted here -->
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 1rem;">üìù Script Ideal</h3>
          <div class="ideal-script" id="ideal-script-content">
            <!-- Ideal script will be inserted here -->
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" id="try-again-btn">Tentar Novamente</button>
          <button class="btn btn-primary" id="next-prompt-btn">Pr√≥ximo Prompt</button>
        </div>
      </div>

      <!-- Modal de Preview do Script -->
      <div id="script-preview-modal" class="modal hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;" onclick="if(event.target === this) closeScriptPreview()">
        <div class="modal-content" style="background: var(--bg-card); border-radius: 16px; max-width: 600px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border-color);" onclick="event.stopPropagation()">
          <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h3 id="preview-prompt-title" style="margin: 0; font-size: 1.1rem;"></h3>
            <button class="close-modal" style="background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem;" onclick="closeScriptPreview()">‚úï</button>
          </div>
          <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
            <div class="preview-script-text" id="preview-script-text" style="font-size: 1rem; line-height: 1.8; white-space: pre-wrap; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;"></div>
            <div class="preview-checklist">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--text-secondary);">üìã Checklist:</h4>
              <ul id="preview-checklist" style="margin: 0; padding-left: 1.25rem;"></ul>
            </div>
          </div>
          <div class="modal-footer" style="display: flex; gap: 1rem; padding: 1rem 1.5rem; border-top: 1px solid var(--border-color);">
            <button class="btn btn-secondary" style="flex: 1; padding: 0.75rem; border-radius: 8px; font-size: 1rem; cursor: pointer;" onclick="closeScriptPreview()">Fechar</button>
            <button class="btn btn-primary" style="flex: 1; padding: 0.75rem; border-radius: 8px; font-size: 1rem; cursor: pointer;" onclick="closeAndStart()">Fechar e Come√ßar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="objections" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
      <h1 class="text-center">üí£ Objection Handling</h1>

      <!-- Question Screen -->
      <div id="objection-question" class="timer-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h3 id="objection-number">Obje√ß√£o 1 de 10</h3>
          <div id="objection-timer" style="font-size: 1.5rem; font-weight: 700; color: var(--color-warning);">5</div>
        </div>

        <div class="card" style="background: var(--bg-secondary); padding: 2rem; margin-bottom: 2rem;">
          <p id="objection-text" style="font-size: 1.125rem; line-height: 1.6; font-weight: 500;"></p>
        </div>

        <div id="objection-options" style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Options will be inserted here -->
        </div>

        <div style="margin-top: 2rem; text-align: center;">
          <span id="objection-score" class="text-muted">Score: 0/0</span>
        </div>
      </div>

      <!-- Feedback Screen -->
      <div id="objection-feedback" class="timer-container" style="display: none;">
        <div id="feedback-result" style="text-align: center; font-size: 2rem; font-weight: 700; margin-bottom: 2rem;">
          <!-- ‚úÖ Correto! / ‚ö†Ô∏è Parcial / ‚ùå Errado -->
        </div>

        <div class="card">
          <h3 style="margin-bottom: 1rem;">üí° Explica√ß√£o</h3>
          <p id="feedback-explanation" style="line-height: 1.6;"></p>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 1rem;">üìù Script Ideal</h3>
          <div class="ideal-script" id="feedback-ideal-script"></div>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
          <span id="feedback-score" class="text-muted" style="display: block; margin-bottom: 1rem;">Score: 0/0</span>
          <button class="btn btn-primary" id="next-objection-btn" style="width: 100%; max-width: 300px;">
            Pr√≥xima Obje√ß√£o
          </button>
        </div>
      </div>

      <!-- Session Complete Screen -->
      <div id="objection-complete" class="timer-container" style="display: none; text-align: center;">
        <h2 style="color: var(--accent-primary); margin-bottom: 2rem;">üéâ Sess√£o Completa!</h2>

        <div class="card">
          <h3 style="font-size: 3rem; margin-bottom: 0.5rem;" id="final-score-display">0/10</h3>
          <p class="text-muted">Corretas</p>
        </div>

        <div class="btn-group" style="margin-top: 2rem;">
          <button class="btn btn-secondary" onclick="navigateTo('dashboard')">Voltar</button>
          <button class="btn btn-primary" id="restart-objections-btn">Tentar Novamente</button>
        </div>
      </div>
    </div>
  </div>

  <div id="vicio-police" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
      <h1 class="text-center">üö® V√≠cio Police</h1>

      <!-- Tela Inicial -->
      <div id="vicio-start" class="card text-center">
        <p>Detecta palavras proibidas enquanto voc√™ pratica respostas.</p>
        <p class="text-muted">Requer conex√£o internet est√°vel.</p>
        <button class="btn btn-large" onclick="startVicioPolice()">üé§ Iniciar Pr√°tica</button>
      </div>

      <!-- Tela de Pr√°tica -->
      <div id="vicio-practice" class="vicio-practice hidden">
        <div class="vicio-prompt-display" id="vicio-prompt"></div>

        <div class="vicio-status" id="vicio-status">
          üé§ Conectando ao Gemini...
        </div>

        <div class="transcript-box" id="vicio-transcript"></div>

        <div id="vicio-alerts" class="vicio-alerts"></div>

        <button class="btn btn-error" onclick="stopVicioPolice()">‚èπÔ∏è Parar</button>
      </div>

      <!-- Tela de Resultados -->
      <div id="vicio-results" class="hidden">
        <h2>üìä Summary</h2>

        <div class="vicio-stats-grid">
          <div class="stat-block stat-error">
            <h3>‚ùå Palavras Proibidas</h3>
            <div class="stat-count" id="forbidden-count">0</div>
            <ul id="forbidden-list" class="stat-list"></ul>
          </div>

          <div class="stat-block stat-success">
            <h3>‚úÖ Palavras-Chave Usadas</h3>
            <div class="stat-count" id="desired-count">0</div>
            <ul id="desired-list" class="stat-list"></ul>
          </div>
        </div>

        <div class="vicio-results-actions">
          <button class="btn" onclick="startVicioPolice()">üîÑ Nova Pr√°tica</button>
          <button class="btn" onclick="navigateTo('dashboard')">‚Üê Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- V3.0 - Panic Word Overlay (Full Screen) -->
  <div id="panic-word-overlay" class="panic-word-overlay">
    <div class="panic-word" id="panic-word-text">JOULE</div>
    <div class="panic-context" id="panic-word-context">Fale dos 5 anos de equity</div>
  </div>

  <div id="random-pill" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
      <h1 class="text-center">üé≤ Random Pill</h1>

      <div class="pill-container">
        <div class="pill-type-header" id="pill-type">Loading...</div>
        <div class="pill-content" id="pill-content"></div>
        <div class="pill-actions">
          <button class="btn" onclick="generateRandomPill()">üîÑ Nova Pill</button>
        </div>
      </div>
    </div>
  </div>

  <div id="preflight" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
      <h1 class="text-center">üìã Pre-Flight Checklist</h1>
      <p class="text-center text-muted">05 de janeiro, antes das 17h</p>

      <div class="preflight-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="preflight-progress" style="width: 0%"></div>
        </div>
        <p class="text-center"><span id="preflight-count">0</span> de 16 completos</p>
      </div>

      <div class="checklist-sections">
        <div class="checklist-section">
          <h3>üîß T√âCNICO</h3>
          <div id="checklist-tecnico"></div>
        </div>

        <div class="checklist-section">
          <h3>üè† AMBIENTE</h3>
          <div id="checklist-ambiente"></div>
        </div>

        <div class="checklist-section">
          <h3>üí™ F√çSICO</h3>
          <div id="checklist-fisico"></div>
        </div>

        <div class="checklist-section">
          <h3>üß† MENTAL</h3>
          <div id="checklist-mental"></div>
        </div>
      </div>

      <div class="mini-stories">
        <h2>üìö Revis√£o R√°pida</h2>

        <div class="mini-card" onclick="toggleMiniCard('joule')">
          <h4>Joule Story <span id="joule-icon">‚ñº</span></h4>
          <div id="joule-content" class="mini-content hidden">
            <p id="joule-text"></p>
          </div>
        </div>

        <div class="mini-card" onclick="toggleMiniCard('abc')">
          <h4>ABC Story <span id="abc-icon">‚ñº</span></h4>
          <div id="abc-content" class="mini-content hidden">
            <p id="abc-text"></p>
          </div>
        </div>

        <div class="mini-card" onclick="toggleMiniCard('em')">
          <h4>EM Perspective <span id="em-icon">‚ñº</span></h4>
          <div id="em-content" class="mini-content hidden">
            <p id="em-text"></p>
          </div>
        </div>

        <div class="mini-card closing-card">
          <h4>Closing Question</h4>
          <p class="closing-question" id="closing-text"></p>
        </div>
      </div>

      <button class="btn btn-error" onclick="resetPreflight()">üîÑ Reset Checklist</button>
    </div>
  </div>

  <!-- ============================================
       V4.0 - REHEARSAL MODE VIEW
       ============================================ -->

  <div id="rehearsal-mode" class="view">
    <div class="container">
      <!-- Seletor de Momento -->
      <div class="moment-selector" id="moment-selector">
        <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
        <h1 class="text-center">üé≠ Rehearsal Mode</h1>
        <p class="text-center text-muted">Escolha o momento da entrevista para praticar:</p>

        <div class="moment-buttons" id="moment-buttons">
          <!-- Gerado dinamicamente via JavaScript -->
        </div>
      </div>

      <!-- Lista de Scripts do Momento Selecionado -->
      <div class="script-list hidden" id="script-list">
        <button class="btn back-button" onclick="backToMomentSelector()">‚Üê Voltar aos Momentos</button>
        <h2 id="moment-title" class="text-center"></h2>
        <div id="scripts-container">
          <!-- Gerado dinamicamente via JavaScript -->
        </div>
      </div>

      <!-- Tela de Pr√°tica Individual -->
      <div class="practice-screen hidden" id="practice-screen">
        <!-- Cabe√ßalho do Script -->
        <div class="practice-header">
          <button class="btn back-button" onclick="backToScriptList()">‚Üê Voltar √† Lista</button>
          <div class="script-meta">
            <h2 id="practice-title"></h2>
            <span class="duration-badge" id="practice-duration"></span>
          </div>
        </div>

        <!-- √Årea do Script -->
        <div class="script-area">
          <div class="script-text" id="script-text">
            <!-- Script completo aqui -->
          </div>

          <!-- Dicas -->
          <div class="tips-section">
            <h4>üí° Dicas:</h4>
            <ul id="tips-list"></ul>
          </div>
        </div>

        <!-- Controles de Pr√°tica -->
        <div class="practice-controls">
          <button class="tts-btn" id="tts-btn" onclick="speakRehearsalScript()">
            üîä Ouvir Script
          </button>
          <button class="record-btn" id="record-btn" onclick="toggleRehearsalRecording()">
            üé§ Gravar Minha Fala
          </button>
        </div>

        <!-- Controles de √Åudio Gravado -->
        <div class="audio-controls" id="audio-controls" style="display: none; margin-bottom: var(--spacing-lg); gap: var(--spacing-sm);">
          <button class="btn btn-secondary" onclick="playLastRecording()" style="flex: 1; padding: var(--spacing-md); border-radius: 8px;">
            ‚ñ∂Ô∏è Ouvir Minha Grava√ß√£o
          </button>
          <button class="btn btn-secondary" onclick="downloadLastRecording()" style="flex: 1; padding: var(--spacing-md); border-radius: 8px;">
            üíæ Baixar √Åudio
          </button>
        </div>

        <!-- √Årea de Feedback da IA (aparece ap√≥s grava√ß√£o) -->
        <div class="ai-feedback hidden" id="ai-feedback">
          <h4>ü§ñ Feedback do Treinador:</h4>
          <div class="feedback-content" id="feedback-content">
            <!-- Feedback da IA aqui -->
          </div>
          <div class="transcript-section">
            <h5>üìù O que voc√™ disse:</h5>
            <div id="user-transcript"></div>
          </div>
          <div class="comparison-section">
            <h5>üìä Frases-chave detectadas:</h5>
            <div class="key-phrases-check" id="key-phrases-check">
              <!-- Checklist de frases-chave -->
            </div>
          </div>
        </div>

        <!-- Bot√µes de Navega√ß√£o -->
        <div class="navigation-buttons">
          <button class="btn btn-secondary" onclick="previousScript()">
            ‚Üê Anterior
          </button>
          <button class="btn btn-primary" onclick="nextScript()">
            Pr√≥ximo ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================
       SECTION: AUDIO COACH MODE
       ============================================ -->

  <div id="audio-coach" class="view">
    <div class="container">
      <button class="btn back-button" onclick="navigateTo('dashboard')">‚Üê Voltar</button>
      <h1 class="text-center">üéß Audio Coach</h1>
      <p class="text-center text-muted" style="margin-bottom: var(--spacing-xl);">
        Ou√ßa scripts e respostas ideais enquanto dirige, cozinha ou descansa
      </p>

      <!-- Category Selector -->
      <div class="audio-category-selector">
        <h3>Escolha a categoria:</h3>
        <select id="audio-category" onchange="buildAudioPlaylist()">
          <option value="all">üé≤ Tudo (Shuffle Completo)</option>
          <option value="killer">‚≠ê Killer Stories</option>
          <option value="opening">üé¨ Opening (Abertura)</option>
          <option value="about-me">üë§ About Me</option>
          <option value="stories">üìñ Killer Stories</option>
          <option value="equity">üíº Equity Experience</option>
          <option value="technical">üéì Technical Deep Dive</option>
          <option value="differentiation">üí™ Differentiation</option>
          <option value="closing">ü§ù Closing</option>
          <option value="objections">üí£ Objections</option>
        </select>
      </div>

      <!-- Now Playing Display -->
      <div class="now-playing" id="now-playing">
        <div class="now-playing-icon">üéß</div>
        <div class="now-playing-info">
          <div class="now-playing-title" id="now-playing-title">
            Select a category and press Play
          </div>
          <div class="now-playing-subtitle" id="now-playing-subtitle">
            Ready to start
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="audio-progress">
        <div class="audio-progress-bar">
          <div class="audio-progress-fill" id="audio-progress-fill"></div>
        </div>
        <div class="audio-progress-text" id="audio-progress-text">
          0 / 0
        </div>
      </div>

      <!-- Playback Controls -->
      <div class="audio-controls-panel">
        <button class="audio-control-btn" id="prev-btn" onclick="skipPrevious()" disabled>
          <span style="font-size: 2rem;">‚èÆÔ∏è</span>
        </button>

        <button class="audio-control-btn audio-control-btn-play" id="play-pause-btn" onclick="togglePlayPause()">
          <span style="font-size: 3rem;">‚ñ∂Ô∏è</span>
        </button>

        <button class="audio-control-btn" id="stop-btn" onclick="stopAudioCoach()" disabled>
          <span style="font-size: 2rem;">‚èπÔ∏è</span>
        </button>

        <button class="audio-control-btn" id="next-btn" onclick="skipNext()" disabled>
          <span style="font-size: 2rem;">‚è≠Ô∏è</span>
        </button>
      </div>

      <!-- Settings -->
      <div class="audio-settings">
        <div class="audio-setting-item">
          <label class="audio-setting-label">
            <input type="checkbox" id="use-gemini-toggle" checked onchange="toggleGeminiTTS()">
            <span>üéôÔ∏è Gemini TTS (Natural AI voice)</span>
          </label>
        </div>

        <div class="audio-setting-item">
          <label class="audio-setting-label">
            <span>üé§ Voice:</span>
            <select id="voice-selector" onchange="updateVoice()">
              <optgroup label="üéôÔ∏è Professional (Male/Neutral)">
                <option value="Charon">Charon (Informative)</option>
                <option value="Fenrir">Fenrir (Authoritative)</option>
                <option value="Orus" selected>Orus (Firm)</option>
                <option value="Iapetus">Iapetus (Clear)</option>
                <option value="Algenib">Algenib (Gravelly)</option>
                <option value="Gacrux">Gacrux (Mature)</option>
                <option value="Sadaltager">Sadaltager (Knowledgeable)</option>
              </optgroup>
              <optgroup label="‚ú® Friendly (Male/Neutral)">
                <option value="Puck">Puck (Upbeat)</option>
                <option value="Achird">Achird (Friendly)</option>
                <option value="Zubenelgenubi">Zubenelgenubi (Casual)</option>
              </optgroup>
              <optgroup label="üéµ Smooth (Female/Neutral)">
                <option value="Kore">Kore (Firm)</option>
                <option value="Zephyr">Zephyr (Bright)</option>
                <option value="Algieba">Algieba (Smooth)</option>
                <option value="Despina">Despina (Smooth)</option>
                <option value="Schedar">Schedar (Even)</option>
                <option value="Sulafat">Sulafat (Warm)</option>
              </optgroup>
            </select>
          </label>
        </div>

        <div class="audio-setting-item">
          <label class="audio-setting-label">
            <input type="checkbox" id="loop-toggle" checked onchange="toggleLoop()">
            <span>üîÅ Loop (Repeat playlist infinitely)</span>
          </label>
        </div>

        <div class="audio-setting-item">
          <label class="audio-setting-label">
            <input type="checkbox" id="auto-pause-toggle" checked>
            <span>‚è∏Ô∏è Auto-pause between scripts (3s to think)</span>
          </label>
        </div>

        <div class="audio-setting-item">
          <label class="audio-setting-label">
            <span>üéöÔ∏è Speed:</span>
            <select id="speech-rate" onchange="updateSpeechRate()">
              <option value="0.75">0.75x</option>
              <option value="1.0" selected>1.0x (Normal)</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Playlist Display -->
      <div class="audio-playlist">
        <h4>üìã Playlist (clique para pular para o item):</h4>
        <div id="playlist-items" class="playlist-items">
          <!-- Items gerados dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================
       JAVASCRIPT - APP LOGIC
       ============================================ -->

  <!-- Load data module first -->
  <script src="js/data.js"></script>

  <script>
    // ============================================
    // SECTION 9: NEW FEATURES (TTS & PANIC)
    // ============================================

    function speakCard() {
      if (!window.speechSynthesis) return;
      
      // Cancel any ongoing speech
      window.speechSynthesis.cancel();

      const card = state.filteredCards[state.currentCardIndex];
      const text = state.isCardFlipped ? card.back : card.front;
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.9; // Slightly slower for clarity
      
      window.speechSynthesis.speak(utterance);
    }

    function showPanicBridge() {
      document.getElementById('panic-overlay').style.display = 'block';
      if (navigator.vibrate) navigator.vibrate(50);
    }

    function closePanic() {
      document.getElementById('panic-overlay').style.display = 'none';
    }

    // ==========================================
    // V3.0 - PANIC WORD (Full-Screen Single Word)
    // ==========================================

    function showPanicWord() {
      // Pick random panic word from panicWords array
      const randomWord = panicWords[Math.floor(Math.random() * panicWords.length)];

      // Update overlay content
      document.getElementById('panic-word-text').textContent = randomWord.word;
      document.getElementById('panic-word-context').textContent = randomWord.context;

      // Show overlay
      const overlay = document.getElementById('panic-word-overlay');
      overlay.classList.add('active');

      // Vibrate for emphasis
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }

      // Auto-hide after 3 seconds
      setTimeout(() => {
        overlay.classList.remove('active');
      }, 3000);
    }

    // ============================================
    // SECTION 1: CONSTANTS & DATA
    // ============================================

    const INTERVIEW_DATE = new Date('2026-01-05T17:00:00-03:00');

    // Gemini API Configuration - Uses Vercel Edge Functions to protect API key
    // API key is stored in Vercel environment variables (GEMINI_API_KEY)
    const GEMINI_TTS_PROXY = '/api/gemini-tts';
    const GEMINI_REST_PROXY = '/api/gemini-rest';
    const GEMINI_WS_PROXY = '/api/gemini-ws';

    // Data constants are loaded from js/data.js
    // They are available as global variables (keyPhrases, flashcardsData, etc.)
    // and also via window.appData object

    // ============================================
    // SECTION 2: STATE MANAGEMENT
    // ============================================

    const state = {
      currentView: 'dashboard',
      currentCardIndex: 0,
      currentPhraseIndex: 0,
      filteredCards: [],  // Will be populated in initFlashcards()
      reviewNeeded: [],
      knownCards: [],
      isCardFlipped: false,
      // Timer state
      selectedTime: 60,
      currentPromptIndex: 0,
      timerRunning: false,
      timerStartTime: null,
      timerInterval: null,
      // Objections state
      currentObjectionIndex: 0,
      objectionsAnswered: 0,
      objectionsCorrect: 0,
      objectionTimer: null,
      objectionTimeRemaining: 5,
      // Random Pill state
      currentQuiz: null,
      // V√≠cio Police state
      vicioWebSocket: null,
      vicioMediaRecorder: null,
      vicioAudioStream: null,
      vicioTranscript: '',
      vicioStats: { forbidden: {}, desired: {} },
      vicioIsListening: false,
      vicioCurrentPrompt: null,
      // Audio Coach state (Gemini TTS)
      audioCoachPlaylist: [],
      audioCoachCurrentIndex: 0,
      audioCoachIsPlaying: false,
      audioCoachIsPaused: false,
      audioCoachLoopEnabled: true,
      audioCoachSpeechRate: 1.0,
      audioCoachCategory: 'all',
      audioCoachAudioElement: null,       // HTMLAudioElement for Gemini TTS playback
      audioCoachVoiceName: 'Orus',        // Selected Gemini voice (American English)
      audioCoachAudioCache: new Map(),    // Cache for generated audio
      audioCoachUseGemini: true           // Use Gemini TTS (fallback to Web Speech if fails)
    };

    // ============================================
    // SECTION 3: NAVIGATION
    // ============================================

    function navigateTo(viewId) {
      // Hide all views
      document.querySelectorAll('.view').forEach(view => {
        view.classList.remove('active');
      });

      // Show target view
      const targetView = document.getElementById(viewId);
      if (targetView) {
        targetView.classList.add('active');
        state.currentView = viewId;
        window.location.hash = viewId;

        // Initialize view-specific logic
        if (viewId === 'flashcards') {
          initFlashcards();
        } else if (viewId === 'pitch') {
          initPitchTimer();
        } else if (viewId === 'objections') {
          initObjections();
        } else if (viewId === 'random-pill') {
          initRandomPill();
        } else if (viewId === 'preflight') {
          initPreFlight();
        } else if (viewId === 'vicio-police') {
          initVicioPolice();
        } else if (viewId === 'audio-coach') {
          initAudioCoach();
        }
      }
    }

    // Handle browser back/forward
    window.addEventListener('hashchange', () => {
      const hash = window.location.hash.slice(1) || 'dashboard';
      if (hash !== state.currentView) {
        navigateTo(hash);
      }
    });

    // ============================================
    // SECTION 4: COUNTDOWN TIMER
    // ============================================

    function updateCountdown() {
      const now = new Date();
      const diff = INTERVIEW_DATE - now;

      const countdownEl = document.getElementById('countdown-display');

      if (diff <= 0) {
        countdownEl.textContent = 'ENTREVISTA AGORA! üéØ';
        countdownEl.classList.add('today');
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

      // Check if today
      const isToday = days === 0;

      if (isToday) {
        countdownEl.textContent = `HOJE! Faltam ${hours}h ${minutes}min`;
        countdownEl.classList.add('today');
      } else {
        countdownEl.textContent = `${days} dias, ${hours} horas, ${minutes} minutos`;
        countdownEl.classList.remove('today');
      }
    }

    // Update countdown every minute
    setInterval(updateCountdown, 60000);

    // ============================================
    // SECTION 5: PHRASE ROTATION
    // ============================================

    function displayPhrase() {
      const phraseEl = document.getElementById('phrase-text');
      phraseEl.textContent = keyPhrases[state.currentPhraseIndex];
    }

    function nextPhrase() {
      state.currentPhraseIndex = (state.currentPhraseIndex + 1) % keyPhrases.length;
      displayPhrase();
    }

    // Auto-rotate phrases every 30 seconds
    let phraseInterval = setInterval(nextPhrase, 30000);

    // Reset interval when user manually clicks
    document.getElementById('phrase-moment')?.addEventListener('click', () => {
      clearInterval(phraseInterval);
      phraseInterval = setInterval(nextPhrase, 30000);
    });

    // ============================================
    // SECTION 6: FLASHCARDS LOGIC
    // ============================================

    function initFlashcards() {
      // Initialize filteredCards if empty (first time loading)
      if (state.filteredCards.length === 0) {
        state.filteredCards = [...flashcardsData];
      }
      loadState();
      applyFilter();
      displayCurrentCard();
    }

    function displayCurrentCard() {
      if (state.filteredCards.length === 0) {
        document.getElementById('card-front').textContent = 'Nenhum card nesta categoria';
        document.getElementById('card-back').textContent = 'Selecione outra categoria';
        return;
      }

      const card = state.filteredCards[state.currentCardIndex];
      const categoryLabels = {
        'tecnico': 'T√©cnico',
        'historias': 'Hist√≥rias',
        'pessoas': 'Pessoas',
        'frases': 'Frases-Chave',
        'dos-donts': "Do's & Don'ts"
      };

      // Update progress
      document.getElementById('card-progress').textContent =
        `Card ${state.currentCardIndex + 1} de ${state.filteredCards.length}`;

      // Update category badges
      const categoryLabel = categoryLabels[card.category] || card.category;
      document.getElementById('card-category').textContent = categoryLabel;
      document.getElementById('card-category-back').textContent = categoryLabel;

      // Update content
      document.getElementById('card-front').textContent = card.front;
      document.getElementById('card-back').textContent = card.back;

      // Reset flip state
      state.isCardFlipped = false;
      document.getElementById('flashcard').classList.remove('flipped');
    }

    function flipCard() {
      state.isCardFlipped = !state.isCardFlipped;
      const flashcard = document.getElementById('flashcard');
      if (state.isCardFlipped) {
        flashcard.classList.add('flipped');
      } else {
        flashcard.classList.remove('flipped');
      }
    }

    function nextCard() {
      state.currentCardIndex = (state.currentCardIndex + 1) % state.filteredCards.length;
      displayCurrentCard();
    }

    function markForReview() {
      const card = state.filteredCards[state.currentCardIndex];
      if (!state.reviewNeeded.includes(card.id)) {
        state.reviewNeeded.push(card.id);
      }
      saveState();
      nextCard();
    }

    function markAsKnown() {
      const card = state.filteredCards[state.currentCardIndex];
      if (!state.knownCards.includes(card.id)) {
        state.knownCards.push(card.id);
      }
      // Remove from review needed if it was there
      state.reviewNeeded = state.reviewNeeded.filter(id => id !== card.id);
      saveState();
      nextCard();
    }

    function filterByCategory() {
      const filter = document.getElementById('category-filter').value;

      if (filter === 'all') {
        state.filteredCards = [...flashcardsData];
      } else if (filter === 'killer') {
        // IDs of Killer Stories (Joule, ABC, EM, Jeffrey, Modigliani)
        const killerIds = [
          'H1', 'H2', 'H8',       // Joule
          'H3', 'H4', 'F2', 'T22', // ABC
          'H5', 'H6', 'P1', 'P5', 'P6', 'P7', // EM & Jeffrey
          'T6', 'F5', 'T21',      // Modigliani
          'F9', 'F10', 'F11'      // Safety & Closing
        ];
        state.filteredCards = flashcardsData.filter(card => killerIds.includes(card.id));
      } else {
        state.filteredCards = flashcardsData.filter(card => card.category === filter);
      }

      // Prioritize review-needed cards
      const reviewCards = state.filteredCards.filter(card => state.reviewNeeded.includes(card.id));
      const otherCards = state.filteredCards.filter(card => !state.reviewNeeded.includes(card.id));
      state.filteredCards = [...reviewCards, ...reviewCards, ...otherCards]; // Show review cards 2x

      state.currentCardIndex = 0;
      displayCurrentCard();
      saveState();
    }

    function applyFilter() {
      const savedFilter = localStorage.getItem('xai-category-filter');
      if (savedFilter) {
        document.getElementById('category-filter').value = savedFilter;
        filterByCategory();
      } else {
        filterByCategory();
      }
    }

    function shuffleCards() {
      // Fisher-Yates shuffle
      for (let i = state.filteredCards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [state.filteredCards[i], state.filteredCards[j]] = [state.filteredCards[j], state.filteredCards[i]];
      }
      state.currentCardIndex = 0;
      displayCurrentCard();
    }

    // Touch events for swipe gestures
    let touchStartX = 0;
    let touchEndX = 0;

    document.getElementById('flashcard')?.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });

    document.getElementById('flashcard')?.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchEndX - touchStartX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff < 0) {
          // Swipe left - mark for review
          markForReview();
        } else {
          // Swipe right - mark as known
          markAsKnown();
        }
      }
    }

    // ============================================
    // SECTION 6.5: 45-SECOND PITCH TIMER LOGIC
    // ============================================

    function initPitchTimer() {
      // Reset to setup screen
      document.getElementById('pitch-setup').style.display = 'block';
      document.getElementById('pitch-running').style.display = 'none';
      document.getElementById('pitch-review').style.display = 'none';

      // Update prompt display
      updatePromptDisplay();

      // Setup time selector buttons
      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          state.selectedTime = parseInt(this.getAttribute('data-seconds'));
        });
      });

      // Setup START button
      document.getElementById('start-timer-btn').addEventListener('click', startTimer);

      // Setup review buttons
      document.getElementById('try-again-btn').addEventListener('click', () => {
        initPitchTimer();
      });

      document.getElementById('next-prompt-btn').addEventListener('click', () => {
        state.currentPromptIndex = (state.currentPromptIndex + 1) % pitchPrompts.length;
        initPitchTimer();
      });
    }

    function updatePromptDisplay() {
      const prompt = pitchPrompts[state.currentPromptIndex];
      document.getElementById('current-prompt-title').textContent =
        `Prompt ${state.currentPromptIndex + 1} de ${pitchPrompts.length}`;
      document.getElementById('prompt-text').textContent = prompt.prompt;
      document.getElementById('running-prompt').textContent = prompt.prompt;
    }

    function startTimer() {
      // Hide setup, show running screen
      document.getElementById('pitch-setup').style.display = 'none';
      document.getElementById('pitch-running').style.display = 'block';

      // Initialize timer
      state.timerRunning = true;
      state.timerStartTime = performance.now();
      const duration = state.selectedTime * 1000; // Convert to milliseconds

      // Initialize display
      document.getElementById('timer-display').textContent = state.selectedTime;
      document.getElementById('timer-progress').style.width = '0%';
      document.getElementById('wrap-up-message').style.display = 'none';
      document.getElementById('panic-btn').style.display = 'block'; // Show Panic Button

      // Reset timer classes
      const timerDisplay = document.getElementById('timer-display');
      const progressBar = document.getElementById('timer-progress');
      timerDisplay.className = 'timer-display-large';
      progressBar.className = 'progress-bar';

      let hasVibratedYellow = false;
      let hasVibratedRed = false;

      // Update timer using requestAnimationFrame for accuracy
      function updateTimer() {
        if (!state.timerRunning) return;

        const elapsed = performance.now() - state.timerStartTime;
        const remaining = Math.max(0, duration - elapsed);
        const remainingSeconds = Math.ceil(remaining / 1000);
        const progressPercent = (elapsed / duration) * 100;

        // Update display
        document.getElementById('timer-display').textContent = remainingSeconds;
        document.getElementById('timer-progress').style.width = `${Math.min(100, progressPercent)}%`;

        // Color phases based on progress
        if (progressPercent < 60) {
          // Green phase (0-60%)
          timerDisplay.classList.remove('timer-phase-yellow', 'timer-phase-red');
          timerDisplay.classList.add('timer-phase-green');
          progressBar.classList.remove('progress-yellow', 'progress-red');
          progressBar.classList.add('progress-green');
        } else if (progressPercent < 85) {
          // Yellow phase (60-85%)
          timerDisplay.classList.remove('timer-phase-green', 'timer-phase-red');
          timerDisplay.classList.add('timer-phase-yellow');
          progressBar.classList.remove('progress-green', 'progress-red');
          progressBar.classList.add('progress-yellow');

          // Vibrate once when entering yellow
          if (!hasVibratedYellow && navigator.vibrate) {
            navigator.vibrate(200);
            hasVibratedYellow = true;
          }
        } else {
          // Red phase (85-100%)
          timerDisplay.classList.remove('timer-phase-green', 'timer-phase-yellow');
          timerDisplay.classList.add('timer-phase-red');
          progressBar.classList.remove('progress-green', 'progress-yellow');
          progressBar.classList.add('progress-red');
          document.getElementById('wrap-up-message').style.display = 'block';

          // Vibrate pattern when entering red
          if (!hasVibratedRed && navigator.vibrate) {
            navigator.vibrate([100, 50, 100, 50, 100]);
            hasVibratedRed = true;
          }
        }

        // Check if timer is done
        if (remaining <= 0) {
          state.timerRunning = false;
          showReview();
        } else {
          requestAnimationFrame(updateTimer);
        }
      }

      // Start the timer loop
      requestAnimationFrame(updateTimer);
    }

    function stopTimer() {
      state.timerRunning = false;
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
    }

    function showReview() {
      // Hide running screen, show review screen
      document.getElementById('pitch-running').style.display = 'none';
      document.getElementById('pitch-review').style.display = 'block';
      document.getElementById('panic-btn').style.display = 'none'; // Hide Panic Button

      // Get current prompt
      const prompt = pitchPrompts[state.currentPromptIndex];

      // Populate checklist
      const checklistContainer = document.getElementById('review-checklist');
      checklistContainer.innerHTML = '';
      prompt.checklist.forEach(item => {
        const checkItem = document.createElement('div');
        checkItem.className = 'checklist-item';
        checkItem.innerHTML = `<span class="checkbox">‚òê</span> ${item}`;
        checklistContainer.appendChild(checkItem);
      });

      // Populate ideal script
      document.getElementById('ideal-script-content').textContent = prompt.idealScript;
    }

    // === PREVIEW SCRIPT MODAL ===
    function toggleScriptPreview() {
      const currentPrompt = pitchPrompts[state.currentPromptIndex];

      document.getElementById('preview-prompt-title').textContent = currentPrompt.prompt;
      document.getElementById('preview-script-text').textContent = currentPrompt.idealScript;

      document.getElementById('preview-checklist').innerHTML =
        currentPrompt.checklist.map(item => `<li style="margin-bottom: 0.25rem; color: var(--text-muted);">${item}</li>`).join('');

      document.getElementById('script-preview-modal').classList.remove('hidden');
    }

    function closeScriptPreview() {
      document.getElementById('script-preview-modal').classList.add('hidden');
    }

    function closeAndStart() {
      closeScriptPreview();
      // Small delay to close modal before starting
      setTimeout(() => {
        startTimer();
      }, 300);
    }

    // ============================================
    // SECTION 6.6: OBJECTION HANDLING LOGIC
    // ============================================

    function initObjections() {
      // Reset state
      state.currentObjectionIndex = 0;
      state.objectionsAnswered = 0;
      state.objectionsCorrect = 0;

      // Show question screen
      document.getElementById('objection-question').style.display = 'block';
      document.getElementById('objection-feedback').style.display = 'none';
      document.getElementById('objection-complete').style.display = 'none';

      // Setup restart button
      const restartBtn = document.getElementById('restart-objections-btn');
      if (restartBtn) {
        restartBtn.addEventListener('click', initObjections);
      }

      // Show first question
      showObjectionQuestion();
    }

    function showObjectionQuestion() {
      const objection = objections[state.currentObjectionIndex];

      // Update display
      document.getElementById('objection-number').textContent =
        `Obje√ß√£o ${state.currentObjectionIndex + 1} de ${objections.length}`;
      document.getElementById('objection-text').textContent = objection.objection;
      document.getElementById('objection-score').textContent =
        `Score: ${state.objectionsCorrect}/${state.objectionsAnswered}`;

      // Clear and populate options
      const optionsContainer = document.getElementById('objection-options');
      optionsContainer.innerHTML = '';

      objection.options.forEach((option, index) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'btn btn-secondary';
        optionBtn.style.textAlign = 'left';
        optionBtn.style.padding = '1rem';
        optionBtn.textContent = String.fromCharCode(65 + index) + '. ' + option.text;
        optionBtn.addEventListener('click', () => selectAnswer(index));
        optionsContainer.appendChild(optionBtn);
      });

      // Start 5-second countdown
      startObjectionTimer();
    }

    function startObjectionTimer() {
      state.objectionTimeRemaining = 5;
      document.getElementById('objection-timer').textContent = state.objectionTimeRemaining;

      // Clear existing timer
      if (state.objectionTimer) {
        clearInterval(state.objectionTimer);
      }

      // Countdown
      state.objectionTimer = setInterval(() => {
        state.objectionTimeRemaining--;
        document.getElementById('objection-timer').textContent = state.objectionTimeRemaining;

        if (state.objectionTimeRemaining <= 0) {
          clearInterval(state.objectionTimer);
          // Auto-select first option (wrong answer) on timeout
          selectAnswer(-1); // -1 indicates timeout
        }
      }, 1000);
    }

    function selectAnswer(selectedIndex) {
      // Stop timer
      if (state.objectionTimer) {
        clearInterval(state.objectionTimer);
        state.objectionTimer = null;
      }

      // Disable all option buttons
      document.querySelectorAll('#objection-options button').forEach(btn => {
        btn.disabled = true;
      });

      // Show feedback
      showObjectionFeedback(selectedIndex);
    }

    function showObjectionFeedback(selectedIndex) {
      const objection = objections[state.currentObjectionIndex];
      state.objectionsAnswered++;

      // Hide question, show feedback
      document.getElementById('objection-question').style.display = 'none';
      document.getElementById('objection-feedback').style.display = 'block';

      // Determine result
      let result, resultColor, score;

      if (selectedIndex === -1) {
        // Timeout
        result = '‚è±Ô∏è Tempo Esgotado!';
        resultColor = 'var(--color-error)';
        score = 0;
      } else {
        score = objection.options[selectedIndex].score;

        if (selectedIndex === objection.correctIndex) {
          result = '‚úÖ Correto!';
          resultColor = 'var(--accent-primary)';
          state.objectionsCorrect++;
        } else if (score === 1) {
          result = '‚ö†Ô∏è Parcial';
          resultColor = 'var(--color-warning)';
        } else {
          result = '‚ùå Errado';
          resultColor = 'var(--color-error)';
        }
      }

      // Display result
      const resultDiv = document.getElementById('feedback-result');
      resultDiv.textContent = result;
      resultDiv.style.color = resultColor;

      // Display explanation
      document.getElementById('feedback-explanation').textContent = objection.explanation;

      // Display ideal script
      document.getElementById('feedback-ideal-script').textContent = objection.idealScript;

      // Update score
      document.getElementById('feedback-score').textContent =
        `Score: ${state.objectionsCorrect}/${state.objectionsAnswered}`;

      // Setup next button
      const nextBtn = document.getElementById('next-objection-btn');
      nextBtn.onclick = nextObjection;
    }

    function nextObjection() {
      state.currentObjectionIndex++;

      if (state.currentObjectionIndex >= objections.length) {
        // Session complete
        showObjectionComplete();
      } else {
        // Show next question
        document.getElementById('objection-feedback').style.display = 'none';
        document.getElementById('objection-question').style.display = 'block';
        showObjectionQuestion();
      }
    }

    function showObjectionComplete() {
      // Hide feedback, show complete screen
      document.getElementById('objection-feedback').style.display = 'none';
      document.getElementById('objection-complete').style.display = 'block';

      // Display final score
      document.getElementById('final-score-display').textContent =
        `${state.objectionsCorrect}/${objections.length}`;
    }

    // ============================================
    // SECTION 7: LOCALSTORAGE PERSISTENCE
    // ============================================

    function saveState() {
      try {
        localStorage.setItem('xai-review-needed', JSON.stringify(state.reviewNeeded));
        localStorage.setItem('xai-known-cards', JSON.stringify(state.knownCards));
        localStorage.setItem('xai-category-filter', document.getElementById('category-filter')?.value || 'all');
      } catch (e) {
        console.warn('Could not save state to localStorage:', e);
      }
    }

    function loadState() {
      try {
        const reviewNeeded = localStorage.getItem('xai-review-needed');
        const knownCards = localStorage.getItem('xai-known-cards');

        if (reviewNeeded) {
          state.reviewNeeded = JSON.parse(reviewNeeded);
        }
        if (knownCards) {
          state.knownCards = JSON.parse(knownCards);
        }
      } catch (e) {
        console.warn('Could not load state from localStorage:', e);
      }
    }

    // ============================================
    // SECTION 7: RANDOM PILL FUNCTIONS
    // ============================================

    function initRandomPill() {
      generateRandomPill();
    }

    function generateRandomPill() {
      const types = ['frase', 'tip', 'quiz', 'ratio'];
      const type = types[Math.floor(Math.random() * types.length)];

      let content, header;

      switch(type) {
        case 'frase':
          const frase = randomPillData.frases[Math.floor(Math.random() * randomPillData.frases.length)];
          header = 'üí¨ Frase-Chave';
          content = `<p class="pill-text">"${frase}"</p>`;
          break;

        case 'tip':
          const tip = randomPillData.tips[Math.floor(Math.random() * randomPillData.tips.length)];
          header = 'üí° Dica';
          content = `<p class="pill-text">${tip}</p>`;
          break;

        case 'quiz':
          const quiz = randomPillData.quickQuiz[Math.floor(Math.random() * randomPillData.quickQuiz.length)];
          state.currentQuiz = quiz;
          header = '‚ùì Quiz';
          content = `
            <p class="pill-text">${quiz.q}</p>
            <div class="pill-quiz-buttons">
              <button class="btn" onclick="answerQuiz(true)">Verdadeiro</button>
              <button class="btn" onclick="answerQuiz(false)">Falso</button>
            </div>
            <div id="quiz-result" class="quiz-result"></div>
          `;
          break;

        case 'ratio':
          const ratioCards = flashcardsData.filter(c => c.category === 'tecnico');
          if (ratioCards.length === 0) {
            // Fallback if no technical cards found - try again
            generateRandomPill();
            return;
          }
          const ratio = ratioCards[Math.floor(Math.random() * ratioCards.length)];
          header = 'üìä Ratio do Dia';
          content = `
            <h3>${ratio.front}</h3>
            <p class="pill-text">${ratio.back}</p>
          `;
          break;
      }

      document.getElementById('pill-type').textContent = header;
      document.getElementById('pill-content').innerHTML = content;
    }

    function answerQuiz(answer) {
      const correct = state.currentQuiz.a === answer;
      const resultDiv = document.getElementById('quiz-result');

      if (correct) {
        resultDiv.innerHTML = '<p class="quiz-correct">‚úÖ Correto!</p>';
        resultDiv.className = 'quiz-result correct';
      } else {
        resultDiv.innerHTML = '<p class="quiz-wrong">‚ùå Errado!</p>';
        resultDiv.className = 'quiz-result wrong';
      }
    }

    // ============================================
    // SECTION 8: PRE-FLIGHT CHECKLIST FUNCTIONS
    // ============================================

    function initPreFlight() {
      // Load saved state
      const saved = JSON.parse(localStorage.getItem('preflight-checks') || '{}');

      // Render checklists
      Object.keys(preFlightChecklist).forEach(section => {
        const container = document.getElementById(`checklist-${section}`);
        container.innerHTML = '';

        preFlightChecklist[section].forEach((item, index) => {
          const checked = saved[section] && saved[section][index] || false;

          const div = document.createElement('div');
          div.className = 'checkbox-item';
          div.innerHTML = `
            <input type="checkbox"
                   id="${section}-${index}"
                   ${checked ? 'checked' : ''}
                   onchange="togglePreflightItem('${section}', ${index})">
            <label for="${section}-${index}">${item}</label>
          `;
          container.appendChild(div);
        });
      });

      // Populate mini stories
      document.getElementById('joule-text').textContent = miniStories.joule;
      document.getElementById('abc-text').textContent = miniStories.abc;
      document.getElementById('em-text').textContent = miniStories.em;
      document.getElementById('closing-text').textContent = miniStories.closing;

      updatePreflightProgress();
    }

    function togglePreflightItem(section, index) {
      const saved = JSON.parse(localStorage.getItem('preflight-checks') || '{}');

      if (!saved[section]) saved[section] = {};

      const checkbox = document.getElementById(`${section}-${index}`);
      saved[section][index] = checkbox.checked;

      localStorage.setItem('preflight-checks', JSON.stringify(saved));
      updatePreflightProgress();
    }

    function updatePreflightProgress() {
      const saved = JSON.parse(localStorage.getItem('preflight-checks') || '{}');
      let total = 0;
      let completed = 0;

      Object.keys(preFlightChecklist).forEach(section => {
        total += preFlightChecklist[section].length;
        if (saved[section]) {
          completed += Object.values(saved[section]).filter(Boolean).length;
        }
      });

      const percent = Math.round((completed / total) * 100);

      document.getElementById('preflight-progress').style.width = `${percent}%`;
      document.getElementById('preflight-count').textContent = completed;
    }

    function toggleMiniCard(story) {
      const content = document.getElementById(`${story}-content`);
      const icon = document.getElementById(`${story}-icon`);

      content.classList.toggle('hidden');
      icon.textContent = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    }

    function resetPreflight() {
      if (!confirm('Tem certeza que quer resetar o checklist? Isso apagar√° todo o progresso.')) return;

      localStorage.removeItem('preflight-checks');
      initPreFlight();
    }

    // ============================================
    // SECTION 9: AUDIO COACH MODE
    // ============================================

    function initAudioCoach() {
      // Clear cache to force regeneration with new format
      state.audioCoachAudioCache.clear();

      // Build initial playlist based on default category
      const category = document.getElementById('audio-category')?.value || 'all';
      state.audioCoachCategory = category;
      buildAudioPlaylist();
      updateAudioCoachUI();
    }

    // ============================================
    // GEMINI TTS API FUNCTIONS
    // ============================================

    async function generateSpeechWithGemini(text) {
      // V7.0: Enhanced Audio Profile - Coach Alex Persona
      const directorNotes = `# AUDIO PROFILE: Coach Alex - The Interview Prep Mentor

A seasoned executive interview coach with 15 years of experience preparing finance professionals for high-stakes tech interviews. Alex has helped dozens of candidates land roles at top AI companies. Warm, authoritative style - believes in you but demands your best.

## THE SCENE: Private Coaching Session
Evening of January 4th, 2026‚Äîthe night before Jo√£o's final interview at xAI. Focused one-on-one video session. Alex is walking Jo√£o through each moment of tomorrow's interview with Jeffrey Weichsel, providing context and modeling exactly how to respond. Final rehearsal before the big day.

### DELIVERY INSTRUCTIONS

**Three Modes:**
1. **GUIDING** (context): Conversational, encouraging, warm. "Let's practice this..."
2. **QUESTION** (presenting Jeffrey's question): Professional, direct, neutral-curious tone
3. **MODELING** (ideal response): Confident, polished, natural emphasis on key phrases

**Pacing:**
- Brief pause (0.5s) between sections
- Emphasis on KEY PHRASES: "FIVE years at Joule", "SEVEN ratios", "investment committee"
- Slightly slower on critical phrases to aid memorization

**Accent:** American English (General American)

### CONTEXT
Jo√£o Leal, 45, Brazilian finance professional. 5 years Partner at Joule (GARP equity fund), 15 years at Banco ABC Brasil. Interview with Jeffrey Weichsel (xAI Human Data Manager) on Jan 5, 2026. Needs to internalize responses with fluency and natural American pacing.
`;

      // Speed instructions based on rate
      const speedInstructions = {
        0.75: 'Pacing: Speak slowly and clearly, emphasizing each word for maximum clarity.\n',
        1.0: 'Pacing: Speak at a natural, conversational pace.\n',
        1.25: 'Pacing: Speak at a slightly faster, energetic pace.\n',
        1.5: 'Pacing: Speak quickly and efficiently.\n'
      };

      const speedInstruction = speedInstructions[state.audioCoachSpeechRate] || '';

      // Combine director notes + speed + content
      const fullText = directorNotes + speedInstruction + '\n## TRANSCRIPT\n' + text;

      const response = await fetch(GEMINI_TTS_PROXY, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: fullText }]
          }],
          generationConfig: {
            responseModalities: ['AUDIO'],
            speechConfig: {
              voiceConfig: {
                prebuiltVoiceConfig: {
                  voiceName: state.audioCoachVoiceName
                }
              }
            }
          }
        })
      });

      if (!response.ok) {
        throw new Error(`Gemini TTS API error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      // Extract base64 audio from response
      if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.inlineData?.data) {
        return data.candidates[0].content.parts[0].inlineData.data;
      }

      throw new Error('Invalid response format from Gemini TTS API');
    }

    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    }

    function createWavFile(audioData) {
      // WAV file specifications for Gemini TTS output
      const sampleRate = 24000;      // 24kHz
      const numChannels = 1;          // Mono
      const bitsPerSample = 16;       // 16-bit PCM

      // Create WAV header (44 bytes)
      const wavHeader = new ArrayBuffer(44);
      const view = new DataView(wavHeader);

      // RIFF chunk descriptor
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + audioData.length, true);
      writeString(view, 8, 'WAVE');

      // fmt sub-chunk
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);                                      // Subchunk1Size (16 for PCM)
      view.setUint16(20, 1, true);                                       // AudioFormat (1 for PCM)
      view.setUint16(22, numChannels, true);                             // NumChannels
      view.setUint32(24, sampleRate, true);                              // SampleRate
      view.setUint32(28, sampleRate * numChannels * bitsPerSample / 8, true); // ByteRate
      view.setUint16(32, numChannels * bitsPerSample / 8, true);         // BlockAlign
      view.setUint16(34, bitsPerSample, true);                           // BitsPerSample

      // data sub-chunk
      writeString(view, 36, 'data');
      view.setUint32(40, audioData.length, true);

      // Combine header + audio data
      return new Uint8Array([...new Uint8Array(wavHeader), ...audioData]);
    }

    function playAudioFromBase64(base64Audio) {
      // Convert base64 to ArrayBuffer
      const audioData = base64ToArrayBuffer(base64Audio);

      // Create WAV file
      const wavFile = createWavFile(audioData);

      // Create blob and URL
      const blob = new Blob([wavFile], { type: 'audio/wav' });
      const audioUrl = URL.createObjectURL(blob);

      // Create and return Audio element
      const audio = new Audio(audioUrl);
      return audio;
    }

    function showAudioLoadingIndicator() {
      const subtitle = document.getElementById('now-playing-subtitle');
      if (subtitle) {
        subtitle.textContent = 'üéôÔ∏è Generating natural speech...';
        subtitle.style.color = 'var(--accent-primary)';
      }
    }

    function hideAudioLoadingIndicator() {
      const subtitle = document.getElementById('now-playing-subtitle');
      const currentItem = state.audioCoachPlaylist[state.audioCoachCurrentIndex];
      if (subtitle && currentItem) {
        subtitle.textContent = currentItem.momentLabel || '';
        subtitle.style.color = '';
      }
    }

    // ============================================
    // V7.0: COACHING TEXT BUILDER FUNCTIONS
    // ============================================

    function convertTitleToEnglish(title) {
      const titleMap = {
        // Opening
        'Cumprimento Inicial': 'Opening Greeting',
        'Transi√ß√£o P√≥s-Cumprimento': 'Post-Greeting Transition',

        // About Me
        'Tell Me About Yourself - Vers√£o Completa': 'Tell me about yourself',
        'Tell Me About Yourself - Vers√£o 45s': 'Tell me about yourself - concise version',

        // Core Pitch
        'Experi√™ncia em Equity - Foco Joule': 'Tell me about your equity experience',
        'Bridge Cr√©dito-Equity via M&M': 'How does your credit background relate to equity?',
        'Hist√≥ria ABC - Valida√ß√£o do Modelo': 'Tell me about a time you validated a financial model',
        'Perspectiva Emerging Markets': 'What unique perspective do you bring?',

        // Technical
        'DCF Walkthrough': 'Walk me through a DCF',
        'EV/EBITDA vs P/E': 'When would you use EV/EBITDA versus P/E?',
        'Quality of Earnings': 'How do you assess earnings quality?',

        // Differentiation
        'Por que contratar voc√™ vs CFA?': 'Why should we hire you over someone with a CFA?',
        'Por que saindo da Joule?': 'Why are you leaving Joule?',
        'Idade como vantagem': 'You are 45. Is that a concern?',

        // Closing
        'Perguntas para Jeffrey': 'Do you have any questions for me?',
        'Fechamento Final': 'Final Closing Statement',
        'Closing Statement': 'Final Closing Statement',

        // Objections
        'Por que xAI?': 'Why xAI?'
      };

      // Return mapping or original title if already in English
      return titleMap[title] || title;
    }

    function buildCoachingText(item) {
      // Moment contexts for coaching framing
      const momentContexts = {
        'opening': {
          intro: "Let's start with the opening moment. First impressions matter‚Äîthis is when you establish rapport with Jeffrey.",
          transition: "Greet him naturally, like this:"
        },
        'about-me': {
          intro: "Now, the most important question of the interview. Jeffrey will ask you to introduce yourself. This is your chance to frame the entire conversation around your equity experience.",
          transition: "Here's exactly how you should respond. Notice how we lead with Joule:"
        },
        'core-pitch': {
          intro: "Let's practice your core value proposition. This is where you differentiate yourself from other candidates.",
          transition: "Deliver it with confidence, like this:"
        },
        'stories': {
          intro: "Time for a killer story. Stories are memorable‚ÄîJeffrey will remember these details when making his decision.",
          transition: "Here's how you tell it:"
        },
        'equity': {
          intro: "Let's reinforce your equity experience. Remember: lead with Joule, not with credit.",
          transition: "Here's your response:"
        },
        'technical': {
          intro: "Now a technical question. Jeffrey may test your fundamental analysis knowledge. Stay calm and structured.",
          transition: "Here's a clear, confident answer:"
        },
        'bridges': {
          intro: "Now let's practice a critical bridge. This is where you connect different parts of your background and show how they complement each other.",
          transition: "Here's how you make the connection:"
        },
        'quick': {
          intro: "Time for a quick practical question. Jeffrey wants to cover logistics. Be clear and direct.",
          transition: "Answer confidently:"
        },
        'differentiation': {
          intro: "This question is about why YOU specifically. What makes you different from candidates with CFAs or PhDs?",
          transition: "Here's how you reframe it as a strength:"
        },
        'closing': {
          intro: "We're approaching the end of the interview. The closing is crucial‚Äîit's your last chance to address concerns and leave a strong impression.",
          transition: "End with confidence, like this:"
        },
        'objections': {
          intro: "Let's prepare for a tough objection. Jeffrey might challenge you on this. Stay calm, don't get defensive.",
          transition: "Here's how you handle it professionally:"
        }
      };

      const context = momentContexts[item.moment] || {
        intro: "Let's practice this section.",
        transition: "Here's how you should respond:"
      };

      // Convert title to English if necessary
      const englishTitle = convertTitleToEnglish(item.title);

      // Determine if it's a direct question
      const isQuestion = englishTitle.includes('?') ||
                         englishTitle.toLowerCase().startsWith('tell me') ||
                         englishTitle.toLowerCase().startsWith('why') ||
                         englishTitle.toLowerCase().startsWith('what') ||
                         englishTitle.toLowerCase().startsWith('how') ||
                         englishTitle.toLowerCase().startsWith('walk me');

      let textToSpeak;

      if (isQuestion) {
        // Format for direct questions
        textToSpeak = `${context.intro}

Jeffrey will ask: "${englishTitle}"

${context.transition}

${item.script}`;
      } else {
        // Format for situations/moments (opening, closing, etc.)
        textToSpeak = `${context.intro}

${context.transition}

${item.script}`;
      }

      // Add reminder of key phrases if they exist
      if (item.keyPhrases && item.keyPhrases.length > 0) {
        const topPhrases = item.keyPhrases.slice(0, 3).join(', ');
        textToSpeak += `\n\nRemember the key phrases: ${topPhrases}.`;
      }

      return textToSpeak;
    }

    async function preloadNextItem() {
      const nextIndex = state.audioCoachCurrentIndex + 1;
      if (nextIndex < state.audioCoachPlaylist.length) {
        const nextItem = state.audioCoachPlaylist[nextIndex];
        const cacheKey = `v7.0-${nextItem.id}-${state.audioCoachVoiceName}-${state.audioCoachSpeechRate}`;

        // Only preload if not already in cache
        if (!state.audioCoachAudioCache.has(cacheKey)) {
          try {
            // V7.0: Use coaching text builder
            const textToSpeak = buildCoachingText(nextItem);
            const base64Audio = await generateSpeechWithGemini(textToSpeak);
            state.audioCoachAudioCache.set(cacheKey, base64Audio);
            console.log(`Preloaded audio for: ${nextItem.title}`);
          } catch (error) {
            console.warn('Failed to preload next item:', error);
          }
        }
      }
    }

    function buildAudioPlaylist() {
      const category = document.getElementById('audio-category')?.value || state.audioCoachCategory;
      state.audioCoachCategory = category;
      state.audioCoachPlaylist = [];
      state.audioCoachCurrentIndex = 0;

      // V7.0: Logical ordering of interview moments (based on actual data.js values)
      const momentOrder = [
        'opening',          // 0:00-1:00 - Greetings
        'about-me',         // 1:00-3:00 - Tell me about yourself
        'stories',          // 3:00-6:00 - Killer stories (Joule, ABC, EM)
        'bridges',          // 6:00-9:00 - Bridges (M&M, EM perspective, Why xAI, Why leaving)
        'quick',            // 9:00-11:00 - Quick questions (Availability, Remote, Salary, Concerns)
        'closing',          // 11:00-14:00 - Questions & closing
        'objections'        // Variable - Tough questions (added separately)
      ];

      // Build playlist from rehearsalScripts
      if (category === 'all') {
        // V7.0: Sort by moment order (not random!)
        state.audioCoachPlaylist = [...rehearsalScripts].sort((a, b) => {
          const orderA = momentOrder.indexOf(a.moment);
          const orderB = momentOrder.indexOf(b.moment);

          // Debug log
          console.log(`Sorting: ${a.title} (${a.moment}, order: ${orderA}) vs ${b.title} (${b.moment}, order: ${orderB})`);

          // If same moment, maintain original order
          if (orderA === orderB) {
            return 0;
          }

          return orderA - orderB;
        });

        // Log final playlist order
        console.log('Final playlist order:', state.audioCoachPlaylist.map(s => `${s.moment}: ${s.title}`));

        // Add objections at the end
        objections.forEach(obj => {
          state.audioCoachPlaylist.push({
            id: `objection-${obj.id}`,
            title: `Objection: ${obj.objection}`,
            script: obj.idealScript,
            duration: '60s',
            moment: 'objections',
            momentLabel: 'üí£ Objections',
            isKiller: false,
            keyPhrases: []
          });
        });

      } else if (category === 'killer') {
        // Killer stories also ordered logically
        state.audioCoachPlaylist = rehearsalScripts
          .filter(s => s.isKiller)
          .sort((a, b) => {
            const orderA = momentOrder.indexOf(a.moment);
            const orderB = momentOrder.indexOf(b.moment);
            return orderA - orderB;
          });

      } else if (category === 'objections') {
        // Only objections
        objections.forEach(obj => {
          state.audioCoachPlaylist.push({
            id: `objection-${obj.id}`,
            title: `Objection: ${obj.objection}`,
            script: obj.idealScript,
            duration: '60s',
            moment: 'objections',
            momentLabel: 'üí£ Objections',
            isKiller: false,
            keyPhrases: []
          });
        });

      } else {
        // Specific category - maintain original order
        state.audioCoachPlaylist = rehearsalScripts.filter(s => s.moment === category);
      }

      updatePlaylistUI();
      updateAudioCoachUI();
    }

    function updatePlaylistUI() {
      const container = document.getElementById('playlist-items');
      if (!container) return;

      container.innerHTML = '';

      state.audioCoachPlaylist.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `playlist-item ${item.isKiller ? 'is-killer' : ''} ${index === state.audioCoachCurrentIndex ? 'active' : ''}`;
        div.onclick = () => jumpToIndex(index);

        div.innerHTML = `
          <span class="playlist-item-number">${index + 1}</span>
          <span class="playlist-item-title">${item.title}</span>
          <span class="playlist-item-duration">${item.duration || ''}</span>
        `;

        container.appendChild(div);
      });
    }

    function updateAudioCoachUI() {
      const currentItem = state.audioCoachPlaylist[state.audioCoachCurrentIndex];

      // Update Now Playing
      if (currentItem) {
        document.getElementById('now-playing-title').textContent = currentItem.title;
        document.getElementById('now-playing-subtitle').textContent = currentItem.momentLabel || '';
      } else {
        document.getElementById('now-playing-title').textContent = 'No items in playlist';
        document.getElementById('now-playing-subtitle').textContent = 'Select a category';
      }

      // Update progress
      const total = state.audioCoachPlaylist.length;
      const current = state.audioCoachCurrentIndex + 1;
      const percentage = total > 0 ? (current / total) * 100 : 0;

      document.getElementById('audio-progress-fill').style.width = `${percentage}%`;
      document.getElementById('audio-progress-text').textContent = `${current} / ${total}`;

      // Update play/pause button
      const playBtn = document.getElementById('play-pause-btn');
      if (playBtn) {
        playBtn.innerHTML = state.audioCoachIsPlaying && !state.audioCoachIsPaused
          ? '<span style="font-size: 3rem;">‚è∏Ô∏è</span>'
          : '<span style="font-size: 3rem;">‚ñ∂Ô∏è</span>';
      }

      // Enable/disable navigation buttons
      document.getElementById('prev-btn').disabled = state.audioCoachCurrentIndex === 0;
      document.getElementById('next-btn').disabled = state.audioCoachCurrentIndex >= state.audioCoachPlaylist.length - 1 && !state.audioCoachLoopEnabled;

      // Enable/disable stop button (only enabled when playing)
      document.getElementById('stop-btn').disabled = !state.audioCoachIsPlaying;

      // Update playlist active state
      document.querySelectorAll('.playlist-item').forEach((item, index) => {
        if (index === state.audioCoachCurrentIndex) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    function togglePlayPause() {
      if (state.audioCoachPlaylist.length === 0) {
        alert('No items in playlist. Please select a category first.');
        return;
      }

      if (state.audioCoachIsPlaying && !state.audioCoachIsPaused) {
        // Pause
        pauseAudioCoach();
      } else if (state.audioCoachIsPaused) {
        // Resume
        resumeAudioCoach();
      } else {
        // Start playing
        playCurrentItem();
      }
    }

    async function playCurrentItem() {
      const item = state.audioCoachPlaylist[state.audioCoachCurrentIndex];
      if (!item) return;

      // Stop any existing audio
      if (state.audioCoachAudioElement) {
        state.audioCoachAudioElement.pause();
        state.audioCoachAudioElement.src = '';
      }

      // Update state
      state.audioCoachIsPlaying = true;
      state.audioCoachIsPaused = false;
      updateAudioCoachUI();

      // V7.0: Use coaching text builder for contextual framing
      const textToSpeak = buildCoachingText(item);

      // Try Gemini TTS first, fallback to Web Speech API if fails
      if (state.audioCoachUseGemini) {
        try {
          await playWithGeminiTTS(item, textToSpeak);
        } catch (error) {
          console.warn('Gemini TTS failed, falling back to Web Speech API:', error);
          playWithWebSpeechAPI(item, textToSpeak);
        }
      } else {
        playWithWebSpeechAPI(item, textToSpeak);
      }
    }

    async function playWithGeminiTTS(item, textToSpeak) {
      showAudioLoadingIndicator();

      try {
        // V7.0: Cache key includes version to invalidate old cache
        const cacheKey = `v7.0-${item.id}-${state.audioCoachVoiceName}-${state.audioCoachSpeechRate}`;
        let base64Audio;

        if (state.audioCoachAudioCache.has(cacheKey)) {
          console.log('Using cached audio for:', item.title);
          base64Audio = state.audioCoachAudioCache.get(cacheKey);
        } else {
          // Generate new audio
          console.log('Generating audio with Gemini TTS for:', item.title);
          base64Audio = await generateSpeechWithGemini(textToSpeak);

          // Cache the result
          state.audioCoachAudioCache.set(cacheKey, base64Audio);
        }

        hideAudioLoadingIndicator();

        // Convert to playable audio
        const audio = playAudioFromBase64(base64Audio);
        state.audioCoachAudioElement = audio;

        // When audio ends, play next or loop
        audio.onended = () => {
          state.audioCoachIsPlaying = false;
          const autoPause = document.getElementById('auto-pause-toggle')?.checked;
          if (autoPause) {
            setTimeout(() => playNextOrLoop(), 3000);
          } else {
            playNextOrLoop();
          }
        };

        audio.onerror = (error) => {
          console.error('Audio playback error:', error);
          state.audioCoachIsPlaying = false;
          hideAudioLoadingIndicator();
          alert('Audio playback error. Check your connection and try again.');
          updateAudioCoachUI();
        };

        // Play the audio
        await audio.play();

        // Preload next item in background
        preloadNextItem();

        // Update Media Session API (for lock screen controls)
        if ('mediaSession' in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: item.title,
            artist: 'xAI Pocket Trainer (Gemini TTS)',
            album: item.momentLabel || 'Audio Coach',
            artwork: [
              { src: '/icons/icon-192.png', sizes: '192x192', type: 'image/png' },
              { src: '/icons/icon-512.png', sizes: '512x512', type: 'image/png' }
            ]
          });
        }

      } catch (error) {
        hideAudioLoadingIndicator();
        throw error; // Re-throw to trigger fallback
      }
    }

    function playWithWebSpeechAPI(item, textToSpeak) {
      console.log('Using Web Speech API for:', item.title);

      // Stop any existing speech
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }

      // Create utterance
      const utterance = new SpeechSynthesisUtterance(textToSpeak);
      utterance.rate = state.audioCoachSpeechRate;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      utterance.lang = 'en-US';

      // Try to select English voice
      const voices = window.speechSynthesis.getVoices();
      const enVoice = voices.find(v => v.lang.startsWith('en-'));
      if (enVoice) {
        utterance.voice = enVoice;
      }

      // When finished, play next or loop
      utterance.onend = () => {
        state.audioCoachIsPlaying = false;
        const autoPause = document.getElementById('auto-pause-toggle')?.checked;
        if (autoPause) {
          setTimeout(() => playNextOrLoop(), 3000);
        } else {
          playNextOrLoop();
        }
      };

      utterance.onerror = (event) => {
        console.error('Speech synthesis error:', event);
        state.audioCoachIsPlaying = false;
        updateAudioCoachUI();
      };

      // Speak
      window.speechSynthesis.speak(utterance);

      // Update Media Session API
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: item.title,
          artist: 'xAI Pocket Trainer (Browser TTS)',
          album: item.momentLabel || 'Audio Coach',
          artwork: [
            { src: '/icons/icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: '/icons/icon-512.png', sizes: '512x512', type: 'image/png' }
          ]
        });
      }
    }

    function playNextOrLoop() {
      if (state.audioCoachCurrentIndex < state.audioCoachPlaylist.length - 1) {
        skipNext();
      } else if (state.audioCoachLoopEnabled) {
        state.audioCoachCurrentIndex = 0;
        updateAudioCoachUI();
        playCurrentItem();
      } else {
        // End of playlist
        state.audioCoachIsPlaying = false;
        updateAudioCoachUI();
      }
    }

    function pauseAudioCoach() {
      if (state.audioCoachAudioElement) {
        // Gemini TTS (Audio element)
        state.audioCoachAudioElement.pause();
      } else if (window.speechSynthesis) {
        // Web Speech API fallback
        window.speechSynthesis.pause();
      }
      state.audioCoachIsPaused = true;
      updateAudioCoachUI();
    }

    function resumeAudioCoach() {
      if (state.audioCoachAudioElement) {
        // Gemini TTS (Audio element)
        state.audioCoachAudioElement.play();
      } else if (window.speechSynthesis) {
        // Web Speech API fallback
        window.speechSynthesis.resume();
      }
      state.audioCoachIsPaused = false;
      updateAudioCoachUI();
    }

    function skipNext() {
      if (state.audioCoachCurrentIndex < state.audioCoachPlaylist.length - 1) {
        state.audioCoachCurrentIndex++;
        updateAudioCoachUI();
        playCurrentItem();
      } else if (state.audioCoachLoopEnabled) {
        state.audioCoachCurrentIndex = 0;
        updateAudioCoachUI();
        playCurrentItem();
      }
    }

    function skipPrevious() {
      if (state.audioCoachCurrentIndex > 0) {
        state.audioCoachCurrentIndex--;
        updateAudioCoachUI();
        playCurrentItem();
      }
    }

    function jumpToIndex(index) {
      state.audioCoachCurrentIndex = index;
      updateAudioCoachUI();
      if (state.audioCoachIsPlaying) {
        playCurrentItem();
      }
    }

    function stopAudioCoach() {
      // Stop Gemini TTS audio
      if (state.audioCoachAudioElement) {
        // Remove error handler before clearing to prevent false error alerts
        state.audioCoachAudioElement.onerror = null;
        state.audioCoachAudioElement.onended = null;
        state.audioCoachAudioElement.pause();
        state.audioCoachAudioElement.currentTime = 0;
        state.audioCoachAudioElement.src = '';
        state.audioCoachAudioElement = null;
      }

      // Stop Web Speech API
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }

      // Reset state
      state.audioCoachIsPlaying = false;
      state.audioCoachIsPaused = false;

      // Update UI
      updateAudioCoachUI();

      console.log('Audio Coach stopped');
    }

    function toggleLoop() {
      state.audioCoachLoopEnabled = document.getElementById('loop-toggle')?.checked || false;
      updateAudioCoachUI();
    }

    function updateSpeechRate() {
      const rate = parseFloat(document.getElementById('speech-rate')?.value || '1.0');
      state.audioCoachSpeechRate = rate;
      // Clear cache when rate changes (affects Gemini TTS prompt)
      state.audioCoachAudioCache.clear();
    }

    function updateVoice() {
      const voiceName = document.getElementById('voice-selector')?.value || 'Orus';
      state.audioCoachVoiceName = voiceName;
      // Clear cache when voice changes
      state.audioCoachAudioCache.clear();
      console.log('Voice changed to:', voiceName);
    }

    function toggleGeminiTTS() {
      const useGemini = document.getElementById('use-gemini-toggle')?.checked || false;
      state.audioCoachUseGemini = useGemini;
      console.log('Gemini TTS:', useGemini ? 'enabled' : 'disabled (using Web Speech API)');
    }

    // Setup Media Session API for lock screen controls
    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('play', () => {
        if (state.currentView === 'audio-coach') {
          togglePlayPause();
        }
      });

      navigator.mediaSession.setActionHandler('pause', () => {
        if (state.currentView === 'audio-coach') {
          pauseAudioCoach();
        }
      });

      navigator.mediaSession.setActionHandler('previoustrack', () => {
        if (state.currentView === 'audio-coach') {
          skipPrevious();
        }
      });

      navigator.mediaSession.setActionHandler('nexttrack', () => {
        if (state.currentView === 'audio-coach') {
          skipNext();
        }
      });
    }

    // ============================================
    // SECTION 10: SERVICE WORKER REGISTRATION
    // ============================================

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered:', registration);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }

    // ==========================================
    // SECTION 10: V√çCIO POLICE (Gemini Live API)
    // ==========================================

    function initVicioPolice() {
      // Reset state
      state.vicioTranscript = '';
      state.vicioStats = { forbidden: {}, desired: {} };
      state.vicioIsListening = false;

      // Show start screen
      document.getElementById('vicio-start').classList.remove('hidden');
      document.getElementById('vicio-practice').classList.add('hidden');
      document.getElementById('vicio-results').classList.add('hidden');
    }

    async function startVicioPolice() {
      try {
        // Reset stats
        state.vicioStats = { forbidden: {}, desired: {} };
        state.vicioTranscript = '';

        // Pick random prompt from pitchPrompts
        const randomPrompt = pitchPrompts[Math.floor(Math.random() * pitchPrompts.length)];
        state.vicioCurrentPrompt = randomPrompt;

        // Show practice view
        document.getElementById('vicio-start').classList.add('hidden');
        document.getElementById('vicio-results').classList.add('hidden');
        document.getElementById('vicio-practice').classList.remove('hidden');

        document.getElementById('vicio-prompt').textContent = randomPrompt.prompt;
        document.getElementById('vicio-transcript').textContent = '';
        document.getElementById('vicio-alerts').innerHTML = '';
        document.getElementById('vicio-status').textContent = 'üé§ Conectando ao Gemini...';

        // 1. Request microphone permission
        state.vicioAudioStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            channelCount: 1,
            sampleRate: 16000,
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        document.getElementById('vicio-status').textContent = 'üé§ Conectado! Ouvindo...';

        // 2. Connect to Gemini Live API via WebSocket
        // First, get the authenticated WebSocket URL from our proxy
        const wsUrlResponse = await fetch(GEMINI_WS_PROXY);
        const wsUrlData = await wsUrlResponse.json();
        state.vicioWebSocket = new WebSocket(wsUrlData.wsUrl);

        state.vicioWebSocket.onopen = () => {
          console.log('Gemini WebSocket connected');

          // Send initial setup message
          state.vicioWebSocket.send(JSON.stringify({
            setup: {
              model: 'models/gemini-2.5-flash',
              generationConfig: {
                responseModalities: ['TEXT']
              }
            }
          }));

          // Start audio capture
          startAudioCapture();
        };

        state.vicioWebSocket.onmessage = handleGeminiResponse;

        state.vicioWebSocket.onerror = (error) => {
          console.error('WebSocket error:', error);
          showVicioError('Erro na conex√£o com Gemini. Verifique sua internet.');
        };

        state.vicioWebSocket.onclose = () => {
          console.log('Gemini WebSocket closed');
        };

        state.vicioIsListening = true;

      } catch (error) {
        console.error('Failed to start V√≠cio Police:', error);
        showVicioError('Erro ao acessar microfone. Verifique as permiss√µes no navegador.');
      }
    }

    function startAudioCapture() {
      // Setup MediaRecorder to capture audio chunks
      state.vicioMediaRecorder = new MediaRecorder(state.vicioAudioStream, {
        mimeType: 'audio/webm;codecs=opus',
        audioBitsPerSecond: 16000
      });

      state.vicioMediaRecorder.ondataavailable = async (event) => {
        if (event.data.size > 0 && state.vicioWebSocket && state.vicioWebSocket.readyState === WebSocket.OPEN) {
          // Convert audio blob to base64
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64Audio = reader.result.split(',')[1];

            // Send audio chunk to Gemini
            state.vicioWebSocket.send(JSON.stringify({
              realtimeInput: {
                mediaChunks: [{
                  mimeType: 'audio/webm;codecs=opus',
                  data: base64Audio
                }]
              }
            }));
          };
          reader.readAsDataURL(event.data);
        }
      };

      // Capture audio in 100ms chunks for near-real-time
      state.vicioMediaRecorder.start(100);
    }

    function handleGeminiResponse(event) {
      const response = JSON.parse(event.data);

      // Extract transcript from serverContent
      if (response.serverContent?.modelTurn?.parts) {
        for (const part of response.serverContent.modelTurn.parts) {
          if (part.text) {
            const newText = part.text;
            state.vicioTranscript += ' ' + newText;

            // Update transcript display
            updateTranscriptDisplay(state.vicioTranscript);

            // Detect forbidden/desired words in new text
            detectWords(newText);
          }
        }
      }
    }

    function updateTranscriptDisplay(transcript) {
      const transcriptBox = document.getElementById('vicio-transcript');
      transcriptBox.textContent = transcript.trim();

      // Auto-scroll to bottom
      transcriptBox.scrollTop = transcriptBox.scrollHeight;
    }

    function detectWords(text) {
      const lowerText = text.toLowerCase();

      // Check forbidden words
      vicioPoliceWords.forbidden.forEach(word => {
        if (lowerText.includes(word.toLowerCase())) {
          showAlert('forbidden', word);
          state.vicioStats.forbidden[word] = (state.vicioStats.forbidden[word] || 0) + 1;

          // Vibrate on forbidden word
          if (navigator.vibrate) {
            navigator.vibrate(200);
          }
        }
      });

      // Check desired words
      vicioPoliceWords.desired.forEach(word => {
        if (lowerText.includes(word.toLowerCase())) {
          showAlert('desired', word);
          state.vicioStats.desired[word] = (state.vicioStats.desired[word] || 0) + 1;
        }
      });

      // V3.0: Check if equity bridge is needed
      checkEquityBridge(state.vicioTranscript);
    }

    // ==========================================
    // V3.0 - RESPONSE COACH: Equity Bridge Check
    // ==========================================

    function checkEquityBridge(fullTranscript) {
      const lowerTranscript = fullTranscript.toLowerCase();

      // Check if user mentioned credit terms without bridging to equity
      const hasCreditTerm = keywordPriority.alert.some(term =>
        lowerTranscript.includes(term.toLowerCase())
      );

      const hasBridge = keywordPriority.blue.some(term =>
        lowerTranscript.includes(term.toLowerCase())
      ) || keywordPriority.gold.some(term =>
        lowerTranscript.includes(term.toLowerCase())
      );

      // Show bridge alert if credit mentioned without bridge
      if (hasCreditTerm && !hasBridge) {
        showBridgeAlert();
      }
    }

    function showBridgeAlert() {
      // Check if alert already visible (don't spam)
      const existingAlert = document.getElementById('bridge-alert');
      if (existingAlert) return;

      const alertDiv = document.createElement('div');
      alertDiv.id = 'bridge-alert';
      alertDiv.className = 'bridge-alert';
      alertDiv.innerHTML = `
        <div style="font-size: 20px; font-weight: bold;">üåâ BRIDGE TO EQUITY NOW!</div>
        <div style="font-size: 14px; margin-top: 4px;">Mencione Modigliani-Miller ou Joule</div>
      `;

      document.body.appendChild(alertDiv);

      // Vibrate for bridge alert (stronger pattern)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
      }

      // Remove after 5 seconds
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
      }, 5000);
    }

    function showAlert(type, word) {
      const alertsDiv = document.getElementById('vicio-alerts');

      const alert = document.createElement('div');
      alert.className = `alert-banner alert-${type}`;

      if (type === 'forbidden') {
        alert.innerHTML = `‚ö†Ô∏è DETECTED: "<strong>${word}</strong>"`;
      } else {
        alert.innerHTML = `‚úÖ GREAT: "<strong>${word}</strong>"`;
      }

      alertsDiv.appendChild(alert);

      // Remove alert after 3 seconds
      setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => alert.remove(), 300);
      }, 3000);

      // Keep only last 3 alerts visible
      const alerts = alertsDiv.querySelectorAll('.alert-banner');
      if (alerts.length > 3) {
        alerts[0].remove();
      }
    }

    function showVicioError(message) {
      const statusDiv = document.getElementById('vicio-status');

      statusDiv.textContent = '‚ùå ' + message;
      statusDiv.style.color = 'var(--color-error)';
    }

    function stopVicioPolice() {
      // Stop audio capture
      if (state.vicioMediaRecorder && state.vicioMediaRecorder.state !== 'inactive') {
        state.vicioMediaRecorder.stop();
      }

      // Stop audio stream
      if (state.vicioAudioStream) {
        state.vicioAudioStream.getTracks().forEach(track => track.stop());
      }

      // Close WebSocket
      if (state.vicioWebSocket) {
        state.vicioWebSocket.close();
      }

      state.vicioIsListening = false;

      // Show results
      showVicioSummary();
    }

    function showVicioSummary() {
      // Hide practice view
      document.getElementById('vicio-practice').classList.add('hidden');

      // Show results view
      document.getElementById('vicio-results').classList.remove('hidden');

      // Populate forbidden words
      const forbiddenList = document.getElementById('forbidden-list');
      const forbiddenCount = document.getElementById('forbidden-count');

      forbiddenList.innerHTML = '';
      const forbiddenWords = Object.keys(state.vicioStats.forbidden);
      forbiddenCount.textContent = forbiddenWords.length;

      if (forbiddenWords.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'Nenhuma palavra proibida detectada! üéâ';
        li.style.color = 'var(--color-success)';
        forbiddenList.appendChild(li);
      } else {
        forbiddenWords.forEach(word => {
          const li = document.createElement('li');
          li.textContent = `"${word}" (${state.vicioStats.forbidden[word]}x)`;
          forbiddenList.appendChild(li);
        });
      }

      // Populate desired words
      const desiredList = document.getElementById('desired-list');
      const desiredCount = document.getElementById('desired-count');

      desiredList.innerHTML = '';
      const desiredWords = Object.keys(state.vicioStats.desired);
      desiredCount.textContent = desiredWords.length;

      if (desiredWords.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'Tente usar mais palavras-chave';
        li.style.color = 'var(--text-muted)';
        desiredList.appendChild(li);
      } else {
        desiredWords.forEach(word => {
          const li = document.createElement('li');
          li.textContent = `"${word}" (${state.vicioStats.desired[word]}x)`;
          desiredList.appendChild(li);
        });
      }
    }

    // ============================================
    // SECTION 9: INITIALIZATION
    // ============================================
    // V4.0 - REHEARSAL MODE FUNCTIONS
    // ============================================

    // === REHEARSAL MODE STATE ===
    let rehearsalState = {
      currentMoment: null,
      currentScriptIndex: 0,
      filteredScripts: [],
      isRecording: false,
      isSpeaking: false,
      mediaRecorder: null,
      audioChunks: [],
      audioStream: null,
      lastRecordingBlob: null,  // Store last recording
      lastRecordingUrl: null     // Store audio URL for playback
    };

    // === NAVIGATION FUNCTIONS ===
    function showRehearsalMode() {
      navigateTo('rehearsal-mode');
      // Initialize rehearsal mode
      initRehearsalMode();
    }

    function initRehearsalMode() {
      // Show moment selector, hide other sections
      document.getElementById('moment-selector').classList.remove('hidden');
      document.getElementById('script-list').classList.add('hidden');
      document.getElementById('practice-screen').classList.add('hidden');

      // Render moment buttons
      renderMomentButtons();
    }

    function renderMomentButtons() {
      const container = document.getElementById('moment-buttons');
      container.innerHTML = interviewMoments.map(moment => `
        <div class="moment-btn" onclick="selectMoment('${moment.id}')">
          <span class="moment-label">${moment.label}</span>
          <span class="moment-time">${moment.timeRange}</span>
          <span class="moment-desc">${moment.description}</span>
        </div>
      `).join('');
    }

    // === MOMENT SELECTION ===
    function selectMoment(momentId) {
      rehearsalState.currentMoment = momentId;
      rehearsalState.currentScriptIndex = 0;

      // Filter scripts for this moment
      rehearsalState.filteredScripts = rehearsalScripts.filter(s => s.moment === momentId);

      // Show script list
      renderScriptList();
    }

    function renderScriptList() {
      const moment = interviewMoments.find(m => m.id === rehearsalState.currentMoment);
      document.getElementById('moment-title').textContent = `${moment.label} - ${moment.description}`;

      const container = document.getElementById('scripts-container');
      container.innerHTML = rehearsalState.filteredScripts.map((script, index) => `
        <div class="script-card ${script.isKiller ? 'is-killer' : ''}" onclick="selectScript(${index})">
          <div class="script-info">
            <h4>${script.title}</h4>
            <span class="duration">‚è±Ô∏è ${script.duration}</span>
          </div>
          ${script.isKiller ? '<span class="killer-badge">‚≠ê KILLER</span>' : ''}
        </div>
      `).join('');

      // Hide moment selector, show script list
      document.getElementById('moment-selector').classList.add('hidden');
      document.getElementById('script-list').classList.remove('hidden');
    }

    function backToMomentSelector() {
      document.getElementById('script-list').classList.add('hidden');
      document.getElementById('moment-selector').classList.remove('hidden');

      // Reset state
      rehearsalState.currentMoment = null;
    }

    // === SCRIPT PRACTICE ===
    function selectScript(index) {
      rehearsalState.currentScriptIndex = index;
      renderPracticeScreen();
    }

    function renderPracticeScreen() {
      const script = rehearsalState.filteredScripts[rehearsalState.currentScriptIndex];

      document.getElementById('practice-title').textContent = script.title;
      document.getElementById('practice-duration').textContent = `‚è±Ô∏è ${script.duration}`;

      // Format script with highlighted key phrases
      const formattedScript = formatScriptWithHighlights(script.script, script.keyPhrases);
      document.getElementById('script-text').innerHTML = formattedScript;

      // Render tips
      document.getElementById('tips-list').innerHTML = script.tips.map(tip => `<li>${tip}</li>`).join('');

      // Hide feedback from previous practice
      document.getElementById('ai-feedback').classList.add('hidden');

      // Hide audio controls
      const audioControls = document.getElementById('audio-controls');
      if (audioControls) {
        audioControls.style.display = 'none';
      }

      // Reset TTS and recording buttons
      const ttsBtn = document.getElementById('tts-btn');
      ttsBtn.textContent = 'üîä Ouvir Script';
      ttsBtn.classList.remove('speaking');

      const recordBtn = document.getElementById('record-btn');
      recordBtn.textContent = 'üé§ Gravar Minha Fala';
      recordBtn.classList.remove('recording');

      // Show practice screen, hide script list
      document.getElementById('script-list').classList.add('hidden');
      document.getElementById('practice-screen').classList.remove('hidden');
    }

    function formatScriptWithHighlights(text, keyPhrases) {
      let formatted = text;
      keyPhrases.forEach(phrase => {
        const regex = new RegExp(`(${phrase})`, 'gi');
        formatted = formatted.replace(regex, '<strong>$1</strong>');
      });
      return formatted;
    }

    function backToScriptList() {
      // Stop any ongoing speech or recording
      if (rehearsalState.isSpeaking) {
        window.speechSynthesis.cancel();
        rehearsalState.isSpeaking = false;
      }
      if (rehearsalState.isRecording) {
        stopRehearsalRecording();
      }

      document.getElementById('practice-screen').classList.add('hidden');
      document.getElementById('script-list').classList.remove('hidden');
    }

    // === TEXT-TO-SPEECH ===
    function speakRehearsalScript() {
      const script = rehearsalState.filteredScripts[rehearsalState.currentScriptIndex];
      const btn = document.getElementById('tts-btn');

      if (rehearsalState.isSpeaking) {
        window.speechSynthesis.cancel();
        rehearsalState.isSpeaking = false;
        btn.textContent = 'üîä Ouvir Script';
        btn.classList.remove('speaking');
        return;
      }

      const utterance = new SpeechSynthesisUtterance(script.script);
      utterance.lang = 'en-US';
      utterance.rate = 0.9; // Slightly slower for clarity

      // Try to use a male American voice
      const voices = window.speechSynthesis.getVoices();
      const preferredVoice = voices.find(v =>
        v.lang === 'en-US' && v.name.includes('Male')
      ) || voices.find(v => v.lang === 'en-US');

      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }

      utterance.onstart = () => {
        rehearsalState.isSpeaking = true;
        btn.textContent = '‚èπÔ∏è Parar';
        btn.classList.add('speaking');
      };

      utterance.onend = () => {
        rehearsalState.isSpeaking = false;
        btn.textContent = 'üîä Ouvir Script';
        btn.classList.remove('speaking');
      };

      window.speechSynthesis.speak(utterance);
    }

    // === RECORDING AND AI ANALYSIS ===
    async function toggleRehearsalRecording() {
      const btn = document.getElementById('record-btn');

      if (rehearsalState.isRecording) {
        stopRehearsalRecording();
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        rehearsalState.audioStream = stream;

        rehearsalState.audioChunks = [];
        rehearsalState.mediaRecorder = new MediaRecorder(stream);

        rehearsalState.mediaRecorder.ondataavailable = (event) => {
          rehearsalState.audioChunks.push(event.data);
        };

        rehearsalState.mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(rehearsalState.audioChunks, { type: 'audio/webm' });
          await processRehearsalRecording(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };

        rehearsalState.mediaRecorder.start();
        rehearsalState.isRecording = true;
        btn.textContent = '‚èπÔ∏è Parar Grava√ß√£o';
        btn.classList.add('recording');

      } catch (error) {
        console.error('Erro ao acessar microfone:', error);
        alert('N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes.');
      }
    }

    function stopRehearsalRecording() {
      if (rehearsalState.mediaRecorder && rehearsalState.isRecording) {
        rehearsalState.mediaRecorder.stop();
        rehearsalState.isRecording = false;

        const btn = document.getElementById('record-btn');
        btn.textContent = 'üé§ Gravar Minha Fala';
        btn.classList.remove('recording');

        // Show loading feedback
        showFeedbackLoading();
      }
    }

    function showFeedbackLoading() {
      const feedbackDiv = document.getElementById('ai-feedback');
      const contentDiv = document.getElementById('feedback-content');

      contentDiv.innerHTML = '<div class="loading-spinner">üîÑ Analisando sua fala...</div>';
      feedbackDiv.classList.remove('hidden');
    }

    // === AI PROCESSING ===
    async function processRehearsalRecording(audioBlob) {
      const script = rehearsalState.filteredScripts[rehearsalState.currentScriptIndex];

      // Save the recording
      rehearsalState.lastRecordingBlob = audioBlob;

      // Revoke old URL if exists
      if (rehearsalState.lastRecordingUrl) {
        URL.revokeObjectURL(rehearsalState.lastRecordingUrl);
      }

      // Create new URL for playback
      rehearsalState.lastRecordingUrl = URL.createObjectURL(audioBlob);

      try {
        // Convert audio to base64
        const base64Audio = await blobToBase64(audioBlob);

        // Transcribe with Gemini
        const transcript = await transcribeWithGemini(base64Audio);

        // Analyze with Gemini (includes audio for pronunciation/pace/confidence analysis)
        const feedback = await analyzeWithGemini(base64Audio, transcript, script);

        // Display result
        displayAIFeedback(transcript, feedback, script);

      } catch (error) {
        console.error('Erro ao processar grava√ß√£o:', error);
        document.getElementById('feedback-content').innerHTML = `
          <p style="color: var(--color-error);">‚ùå Erro ao processar: ${error.message}</p>
          <p>Tente novamente ou verifique sua conex√£o com a internet.</p>
        `;
      }
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    async function transcribeWithGemini(base64Audio) {
      const response = await fetch(GEMINI_REST_PROXY, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              {
                inlineData: {
                  mimeType: 'audio/webm',
                  data: base64Audio
                }
              },
              {
                text: 'Transcribe this audio to text. Return ONLY the transcription, nothing else.'
              }
            ]
          }]
        })
      });

      const data = await response.json();

      if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
        return data.candidates[0].content.parts[0].text;
      }

      throw new Error('N√£o foi poss√≠vel transcrever o √°udio');
    }

    async function analyzeWithGemini(base64Audio, transcript, script) {
      const prompt = `You are an expert interview coach. The speaker is a 45-year-old Brazilian finance professional interviewing for a position at xAI. Listen carefully to the audio recording.

IDEAL SCRIPT (what they should say):
"${script.script}"

KEY PHRASES they must include:
${script.keyPhrases.map(p => `- "${p}"`).join('\n')}

TRANSCRIPTION (for reference only):
"${transcript}"

ANALYZE THE AUDIO for these aspects:

1. **CONTENT**: Did they cover the key points? Which key phrases are missing?

2. **PRONUNCIATION**:
   - Any words that were unclear or mispronounced?
   - Consider Brazilian-English accent patterns (th sounds, word-final consonants, vowel sounds)
   - Note specific words that need practice

3. **PACE/SPEED**:
   - Too fast (rushing, nervous)?
   - Too slow (hesitant, unsure)?
   - Good interview pace?

4. **CONFIDENCE**:
   - Does the voice sound confident and assertive?
   - Any signs of nervousness (shaky voice, trailing off)?
   - Strong or weak ending?

5. **FILLER WORDS**: Count any "um", "uh", "like", "you know", "basically", "right?"

6. **PAUSES**: Natural thinking pauses vs awkward silences?

Return your analysis as JSON:
{
  "overallScore": 0-100,
  "contentScore": 0-100,
  "deliveryScore": 0-100,
  "strengths": ["what they did well - be specific"],
  "improvements": ["actionable suggestions - be specific"],
  "missingKeyPhrases": ["phrases they should have included"],
  "usedKeyPhrases": ["phrases they successfully included"],
  "pronunciationNotes": "specific words to practice with phonetic tips if needed",
  "paceAssessment": "fast|slow|good",
  "paceNote": "specific feedback on speaking speed",
  "confidenceAssessment": "high|medium|low",
  "confidenceNote": "specific feedback on vocal confidence",
  "fillerWordCount": 0,
  "fillerWordsUsed": ["list of filler words detected"],
  "summary": "2-3 sentence encouraging but honest overall feedback"
}

Be encouraging but direct. This is final interview prep - honest feedback helps more than false praise.`;

      const response = await fetch(GEMINI_REST_PROXY, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              {
                inlineData: {
                  mimeType: 'audio/webm',
                  data: base64Audio
                }
              },
              { text: prompt }
            ]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 1500
          }
        })
      });

      const data = await response.json();

      // Debug: Log full response
      console.log('Gemini API Response:', JSON.stringify(data, null, 2));

      // Check for API errors
      if (data.error) {
        console.error('Gemini API Error:', data.error);
        throw new Error(`API Error: ${data.error.message || JSON.stringify(data.error)}`);
      }

      if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
        const text = data.candidates[0].content.parts[0].text;
        console.log('Gemini Response Text:', text);

        // Extract JSON from response
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            const parsedJSON = JSON.parse(jsonMatch[0]);
            console.log('Parsed JSON:', parsedJSON);
            return parsedJSON;
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            console.error('Attempted to parse:', jsonMatch[0]);
            throw new Error('Resposta da API n√£o est√° em formato JSON v√°lido');
          }
        } else {
          console.error('No JSON found in response text');
          throw new Error('Resposta da API n√£o cont√©m JSON');
        }
      }

      console.error('Invalid response structure:', data);
      throw new Error('Formato de resposta inesperado da API');
    }

    function displayAIFeedback(transcript, feedback, script) {
      // Show audio controls
      const audioControls = document.getElementById('audio-controls');
      if (audioControls) {
        audioControls.style.display = 'flex';
      }

      // Score visual
      const scoreColor = feedback.overallScore >= 80 ? 'var(--color-success)' :
                         feedback.overallScore >= 60 ? 'var(--color-warning)' : 'var(--color-error)';

      // Feedback principal
      document.getElementById('feedback-content').innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
          <div style="text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: ${scoreColor};">
              ${feedback.overallScore}/100
            </div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">GERAL</div>
          </div>
          ${feedback.contentScore ? `
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-secondary);">
                ${feedback.contentScore}/100
              </div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">CONTE√öDO</div>
            </div>
          ` : ''}
          ${feedback.deliveryScore ? `
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-secondary);">
                ${feedback.deliveryScore}/100
              </div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">DELIVERY</div>
            </div>
          ` : ''}
        </div>

        <p>${feedback.summary}</p>

        ${feedback.strengths.length > 0 ? `
          <div style="margin-top: 1rem;">
            <strong class="strength">‚úÖ Pontos Fortes:</strong>
            <ul>${feedback.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
          </div>
        ` : ''}

        ${feedback.improvements.length > 0 ? `
          <div style="margin-top: 1rem;">
            <strong class="improvement">üí° Para Melhorar:</strong>
            <ul>${feedback.improvements.map(i => `<li>${i}</li>`).join('')}</ul>
          </div>
        ` : ''}

        ${feedback.pronunciationNotes ? `
          <div style="margin-top: 1rem;">
            <strong style="color: #f59e0b;">üó£Ô∏è Pron√∫ncia:</strong>
            <p style="margin-top: 0.5rem;">${feedback.pronunciationNotes}</p>
          </div>
        ` : ''}

        ${feedback.paceNote ? `
          <div style="margin-top: 1rem;">
            <strong style="color: #3b82f6;">‚è±Ô∏è Velocidade (${feedback.paceAssessment || 'N/A'}):</strong>
            <p style="margin-top: 0.5rem;">${feedback.paceNote}</p>
          </div>
        ` : ''}

        ${feedback.confidenceNote ? `
          <div style="margin-top: 1rem;">
            <strong style="color: #8b5cf6;">üí™ Confian√ßa (${feedback.confidenceAssessment || 'N/A'}):</strong>
            <p style="margin-top: 0.5rem;">${feedback.confidenceNote}</p>
          </div>
        ` : ''}

        ${feedback.fillerWordCount > 0 ? `
          <div style="margin-top: 1rem;">
            <strong style="color: #ef4444;">üö´ Filler Words: ${feedback.fillerWordCount}x</strong>
            <p style="margin-top: 0.5rem; color: var(--text-secondary);">
              Detectados: ${feedback.fillerWordsUsed?.join(', ') || 'N/A'}
            </p>
          </div>
        ` : ''}
      `;

      // Transcri√ß√£o
      document.getElementById('user-transcript').textContent = transcript;

      // Checklist de frases-chave
      const phrasesContainer = document.getElementById('key-phrases-check');
      phrasesContainer.innerHTML = script.keyPhrases.map(phrase => {
        const found = feedback.usedKeyPhrases?.some(p =>
          p.toLowerCase().includes(phrase.toLowerCase()) ||
          phrase.toLowerCase().includes(p.toLowerCase())
        );
        return `<span class="phrase-tag ${found ? 'found' : 'missing'}">${phrase}</span>`;
      }).join('');

      // Mostrar se√ß√£o de feedback
      document.getElementById('ai-feedback').classList.remove('hidden');

      // Scroll para o feedback
      document.getElementById('ai-feedback').scrollIntoView({ behavior: 'smooth' });
    }

    // === AUDIO PLAYBACK & DOWNLOAD ===
    function playLastRecording() {
      if (!rehearsalState.lastRecordingUrl) {
        alert('Nenhuma grava√ß√£o dispon√≠vel. Grave primeiro!');
        return;
      }

      // Create audio element for playback
      const audio = new Audio(rehearsalState.lastRecordingUrl);
      audio.play();
    }

    function downloadLastRecording() {
      if (!rehearsalState.lastRecordingBlob) {
        alert('Nenhuma grava√ß√£o dispon√≠vel. Grave primeiro!');
        return;
      }

      const script = rehearsalState.filteredScripts[rehearsalState.currentScriptIndex];
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      const filename = `rehearsal_${script.id}_${timestamp}.webm`;

      const a = document.createElement('a');
      a.href = rehearsalState.lastRecordingUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // === SCRIPT NAVIGATION ===
    function previousScript() {
      if (rehearsalState.currentScriptIndex > 0) {
        rehearsalState.currentScriptIndex--;
        renderPracticeScreen();
      } else {
        backToScriptList();
      }
    }

    function nextScript() {
      if (rehearsalState.currentScriptIndex < rehearsalState.filteredScripts.length - 1) {
        rehearsalState.currentScriptIndex++;
        renderPracticeScreen();
      } else {
        // End of list, back to moment selector
        backToScriptList();
      }
    }

    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      // Validate data loaded correctly from js/data.js
      if (!flashcardsData || !keyPhrases) {
        console.error('CRITICAL: js/data.js failed to load!');
        alert('Erro ao carregar dados do app. Verifique se js/data.js existe.');
        return; // Stop execution if data didn't load
      }

      // Load initial state
      loadState();

      // Navigate to hash or dashboard
      const hash = window.location.hash.slice(1) || 'dashboard';
      navigateTo(hash);

      // Start countdown
      updateCountdown();

      // Display first phrase
      displayPhrase();

      console.log('xAI Pocket Trainer initialized!');
      console.log(`${flashcardsData.length} flashcards loaded`);
      console.log(`Interview: ${INTERVIEW_DATE.toLocaleString('pt-BR')}`);
    });
  </script>
</body>
</html>
